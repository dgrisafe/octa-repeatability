---
title: "OCTA Repeatability & Reliability â€” Clean Data"
author: "Jae Lee, Bruce Burkemper, Dom Grisafe, Grace Richter"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 1
csl: ophthalmology.csl
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(readxl)           # import excel files
library(tidyverse)
library(Hmisc)
library(lubridate)
library(ICC)              # inter class correlation
library(labelled)         # add variable labels 
library(kableExtra)       # HTML tables
library(tableone)         # table 1
library(cowplot)          # makes clean plots, with no distractions
theme_set(theme_cowplot())
library(gridExtra)        # allows grid arangement of dissimilar plots together
library(grid)             # add labels to top of grid.arrange plots
library(lme4)
library(citr)

# directories
dir_data <- "/Volumes/GoogleDrive/My Drive/2017-2020 USC Roski Eye Institute/OCTA Repeatability - Grace Richter/Data/Jae"
```

#Data{.tabset}

This data was taken from a clean dataset that Jae emailed out on November 26th, 2019.

Jae organized the retina by six different methods. He created OCTA variable scores for the overall image, 2 hemifields, 4 quadrants, 6 sectors, 12 clock hours, and an annular ring.  

Annular image scoring was also assessed, and ICC's were similar, but slightly lower than global. Results for annular image scoring are not shown. For now, only the overall "global" image scoring will be shown.

Zeiss commercial **vessel area density** and **flux** variables are also shown for the global image scoring.

```{r}
# common factor formats
form_eye    <- function(x){factor(x, levels = c(1, 2), labels = c("Left",   "Right"))}
form_ny     <- function(x){factor(x, levels = c(1, 2), labels = c("No",    "Yes"))}
form_female <- function(x){factor(x, levels = c(1, 2), labels = c("Female", "Male"))}
form_glc     <- function(x){factor(x, levels = c(1:4), labels = c("None", "Mild", "Moderate", "Severe"))}
form_glc_bin <- function(x){factor(x, levels = c(1, 2), labels = c("None", "Glaucoma"))}
form_dr     <- function(x){factor(x, levels = c(1:5), labels = c("None", "Mild Non-Proliferative Diabetic Retinopathy", "Moderate Non-Proliferative Diabetic Retinopathy", "Severe Non-Proliferative Diabetic Retinopathy", "Proliferative Diabetic Retinopathy"))}
form_surg   <- function(x){factor(x, levels = c(1:4), labels = c("None", "Laser", "Minimally Invasive Glaucoma Surgery", "Filter"))}
form_ss <- function(x){as.integer(x)}

# function that removes extraneous participants
exclude_patients <- function(df){
  df %>% 
    # patient with false eye
    filter(!(ptid %in% c(6919811)))
}
```

```{r}
# function that formats clinical and demographic variables
form_sociodem_vars <- function(df){
  
  # function that puts factors in base-one notation
  base1 <- function(x){as.double(x) + 1}

  df %>% 
    
    # remove unnecessary variables
    select(-Name, -MRN, -`Clinical Findings`, -Comment) %>%

    rename(
      age = Age
    ) %>% 

    # format variables appropriately
    mutate(
      
      ptid = as.character(SID),
      
      female = case_when(
        Sex == "F" ~ 1,
        Sex == "M" ~ 2
      ) %>% form_female(),
      
      htn_dx = base1(HTN) %>% form_ny(),
       dm_dx = base1(DB) %>% form_ny(),
      nro_dx = base1(Neuropathy) %>% form_ny(),
      
      dr_dx_od = base1(`PDR/NPDR_OD`) %>% form_dr(),
      dr_dx_os = base1(`PDR/NPDR_OS`) %>% form_dr(),
      
      glc_sus_dx_od = base1(GS_OD) %>% form_glc(),
      glc_sus_dx_os = base1(GS_OS) %>% form_glc(),
      
      glc_dx_od = base1(GLC_OD) %>% form_glc(),
      glc_dx_os = base1(GLC_OS) %>% form_glc(),

      surg_proc_catextract_od = base1(`Osx(CE)_OD`) %>% form_ny(),
      surg_proc_catextract_os = base1(`Osx(CE)_OS`) %>% form_ny(),
      
      surg_proc_glaucoma_od = base1(`Osx(GLC)_OD`) %>% form_surg(),
      surg_proc_glaucoma_os = base1(`Osx(GLC)_OS`) %>% form_surg()
      
    ) %>% 
    
    # arrange so in appropriate order
    arrange(ptid) %>% 
    
    # remove old variables
    select(-Sex, -HTN, -DB, -Neuropathy,
           -`PDR/NPDR_OD`, -`PDR/NPDR_OS`, -GS_OD, -GS_OS, -GLC_OD, -GLC_OS,
           -`Osx(CE)_OD`, -`Osx(CE)_OS`, -`Osx(GLC)_OD`, -`Osx(GLC)_OS`)

}
```

```{r}

# function that formats OCTA variables
form_vars <- function(df){

  df %>% 
    
    select(NameSIDSexEyeRegion, everything()) %>% 
    
    mutate(
      
      # match first text (upper or lower case) of any length, followed by any underscore, all repeated any number of times
      name = str_extract(string = NameSIDSexEyeRegion, pattern = regex("^[[A-Za-z]*_]+")) %>% str_sub(end = -2),
      
      # matches everything starting with the first number
      SIDSexEyeRegion = str_extract(string = NameSIDSexEyeRegion, pattern = regex("[[0-9]*].*$"))
      
      ) %>% 
    
    # separate the remaining variables
    separate(
      col = SIDSexEyeRegion, sep = "_", remove = TRUE,
      into = c("ptid", "sex", "image_area", "image_method", "image_size", "exam_date", "exam_time", "eye_imaged")
      ) %>% 
    
    # filter blank rows
    filter(!is.na(exam_date)) %>% 
    
    # format variables appropriately
    mutate(
      
    time_stamp = paste(exam_date, exam_time) %>% as.POSIXct(format = "%m%d%Y %H%M%S"),

    exam_date = exam_date %>% as.Date(format = "%m%d%Y"),
    
    eye_imaged = case_when(
      eye_imaged == "OS" ~ 1,
      eye_imaged == "OD" ~ 2
    ) %>% form_eye(),
    
    female = case_when(
      sex == "F" ~ 1,
      sex == "M" ~ 2
    ) %>% form_female(),
    
    image_area = factor(image_area),

    image_method = factor(image_method),
    
    image_size = factor(image_size),
    
    signal_strength = form_ss(SS)
    
    ) %>% 
    
    # remove unnecessary variables
    select(-NameSIDSexEyeRegion, -sex, -exam_time) %>% 
    
    # arrange so in appropriate order
    arrange(ptid, eye_imaged, time_stamp) %>% 
    
    # create a measurement ID
    mutate(eyeid = group_indices(., ptid, eye_imaged)) %>% 
 
    # deidentify names
    select(-name, -SS) %>%
    
    # reorder variables appropriately
    select(ptid, female, eyeid, eye_imaged, image_area, image_size, image_method, exam_date, time_stamp, everything())
  
}
```

```{r, message = FALSE, warning = FALSE}
# create a function that removes the middle initial and titles from the names

# sociodemographic data
data_sociodem <- read_xlsx(paste0(dir_data, "/R&R_PoHX_IOP_all.xlsx"), sheet = "PoHx") %>% form_sociodem_vars() %>% exclude_patients()

# OCTA data from group's algorithm
data_octa_filename <- paste0(dir_data, "/RR_all_quantification_01_17_2020.xlsx")
data_octa_global <- read_xlsx(data_octa_filename, sheet = "Global") %>% form_vars() %>% exclude_patients()
data_octa_annulus <- read_xlsx(data_octa_filename, sheet = "Annulus") %>% form_vars() %>% exclude_patients()
data_octa_hemifield <- read_xlsx(data_octa_filename, sheet = "Hemifield") %>% form_vars() %>% exclude_patients()
data_octa_quadrant <- read_xlsx(data_octa_filename, sheet = "Quadrants") %>% form_vars() %>% exclude_patients()
data_octa_sector <- read_xlsx(data_octa_filename, sheet = "Sector") %>% form_vars() %>% exclude_patients()
data_octa_clockhour <- read_xlsx(data_octa_filename, sheet = "Clockhours") %>% form_vars() %>% exclude_patients()

# OCTA data from commercial algorithm
data_octa_commercial <- read_xlsx(data_octa_filename, sheet = "Commercial measurement") %>% form_vars() %>% exclude_patients()
```

```{r}

get_eye_long <- function(df, var){
  
  df %>% 
    select(ptid, age, female, htn_dx, dm_dx, nro_dx, starts_with(var)) %>% 
    pivot_longer(
      cols = starts_with(var),
      names_to = "eye_imaged",
      values_to = var
      ) %>% 
    mutate(
      eye_imaged = case_when(
        grepl(x = eye_imaged, pattern = "_os") ~ 1,
        grepl(x = eye_imaged, pattern = "_od") ~ 2
      ) %>% form_eye()
    )
  
}

# multi-merge sociodemographic variables
data_sociodem_long <- list(
  get_eye_long(data_sociodem, "dr_dx"),
  get_eye_long(data_sociodem, "glc_sus_dx"),
  get_eye_long(data_sociodem, "glc_dx"),
  get_eye_long(data_sociodem, "surg_proc_glaucoma"),
  get_eye_long(data_sociodem, "surg_proc_catextract")
  ) %>% 
  reduce(full_join, by = c("ptid", "eye_imaged", "age", "female", "htn_dx", "dm_dx", "nro_dx")) %>% 
  
  mutate(
    
    # create indicator variable for glaucoma status
    glc_dx_bin = case_when(
      glc_dx %in% c("None") ~ 1,
      glc_dx %in% c("Mild", "Moderate", "Severe") ~ 2
      ) %>% factor(c(1:2), c("Normal", "Glaucoma")),
    
    # create indicator variable for diabetic reinopathy status
    dr_dx_bin = case_when(
      dr_dx == "None" ~ 1,
      dr_dx %in% c(
        "Mild Non-Proliferative Diabetic Retinopathy", 
        "Moderate Non-Proliferative Diabetic Retinopathy", 
        "Severe Non-Proliferative Diabetic Retinopathy",
        "Proliferative Diabetic Retinopathy"
        ) ~ 2
    ) %>% form_ny()
    )
```


```{r}

var_labels <- c(
  ptid = "Patient Identification",
  
  # sociodemographic variables
  age = "Age",
  female = "Sex",
  htn_dx = "Hypertension Diagnosis",
  dm_dx = "Diabetes Mellitus Diagnosis",
  nro_dx = "Optic Neuropathy",
  
  # eye clinical variables
  dr_dx = "Diabetic Retinopathy Diagnosis, Ordinal",
  dr_dx_bin = "Diabetic Retinopathy Diagnosis, Binary",
  glc_sus_dx = "Glaucoma Suspect Diagnosis",
  glc_dx = "Glaucoma Diagnosis, Ordinal",
  glc_dx_bin = "Glaucoma Diagnosis, Binary",
  surg_proc_glaucoma = "Surgical Procedure for Glaucoma",
  surg_proc_catextract = "Surgical Procedure for Cataract Extraction",
  
  # OCTA Variables
  eyeid = "Eye Identification",
  eye_imaged = "Eye Imaged",
  time_stamp = "Exam Date and Time",
  name_last = "Last Name",
  name_first = "First Name",
  image_area = "Image Area",
  image_method = "Image Method",
  image_size = "Image Size",
  signal_strength = "Signal Strength",
  v_diameter = "Vessel Diameter (units?)",
  v_area_density = "Vessel Area Density (units?)",
  v_skeleton_density = "Vessel Skeleton Density (units?)",
  v_perimeter_index = "Vessel Perimeter Index (units?)",
  v_complexity_index = "Vessel Complexity Index (units?)",
  flow_impair_zone = "Flow Impairment Zone (units?)",
  flux = "Flux (units?)",
  zeiss_v_area_density = "Vessel Area Density (units?), Zeiss Commercial",
  zeiss_flux = "Flux (units?), Zeiss Commercial"
)

# assign variable labels
data_dict <-  data.frame(var_labels) %>% 
  rownames_to_column("Variable")
```


##Data Wrangling

###Rename Variables

This section will rename the variables to match the dictionary

```{r}

# commercial data had different variable names than the remaining variables
data_octa_commercial_rename <- data_octa_commercial %>%
  # remove unncessary variables
  select(
    ptid, female, eyeid, eye_imaged, image_area, image_size, image_method, exam_date, time_stamp,
    signal_strength, Area_average, Flux_average
    ) %>% 
  # rename commercial variables
  rename(
    zeiss_v_area_density = Area_average,
    zeiss_flux = Flux_average
  )

# function to rename OCTA variables for internal scoring
rename_octa_vars <- function(df){
  
  df %>% 
    
    # rename variables in existing format
    rename(
      v_diameter = starts_with("Vessel Diameter"),
      v_area_density = starts_with("Vessel Area Density"),
      v_skeleton_density = starts_with("Vessel Skeleton Density"),
      v_perimeter_index = starts_with("Vessel Perimeter Index"),
      v_complexity_index = starts_with("Vessel Complexity Index"),
      flow_impair_zone = starts_with("Flow Impiarment Zone"),
      flux = starts_with("Flux")
    ) 
 
}

data_octa_global_rename <- rename_octa_vars(data_octa_global) %>% 
  # add the commercial global variables to the global dataset
  left_join(
    by = c("ptid", "eyeid", "time_stamp", "signal_strength"), 
    y = data_octa_commercial_rename %>% select(ptid, eyeid, time_stamp, signal_strength, zeiss_v_area_density, zeiss_flux)
    ) %>% 
  # add sociodemographic information
  left_join(y = data_sociodem_long, by = c("ptid", "female", "eye_imaged"))
# data_octa_global_rename %>% glimpse

data_octa_annulus_rename <- rename_octa_vars(data_octa_annulus)
# data_octa_hemifield_rename <- rename_octa_vars(data_octa_hemifield)
# data_octa_quadrant_rename <- rename_octa_vars(data_octa_quadrant)
# data_octa_sector_rename <- rename_octa_vars(data_octa_sector)
# data_octa_clockhour_rename <- rename_octa_vars(data_octa_clockhour)

# check out the renamed datasets
# data_octa_global_rename %>% glimpse
# data_octa_annulus_rename %>% glimpse
```


###Label Variables

This section will label variables appropriately.

```{r}
# match variable labels with variable names in dataframe
label(data_octa_global_rename) <- as.list(var_labels[match(names(data_octa_global_rename), names(var_labels))])
label(data_octa_annulus_rename) <- as.list(var_labels[match(names(data_octa_annulus_rename), names(var_labels))])
# label(data_octa_hemifield_rename) <- as.list(var_labels[match(names(data_octa_hemifield_rename), names(var_labels))])
# label(data_octa_quadrant_rename) <- as.list(var_labels[match(names(data_octa_quadrant_rename), names(var_labels))])
# label(data_octa_sector_rename) <- as.list(var_labels[match(names(data_octa_sector_rename), names(var_labels))])
# label(data_octa_clockhour_rename) <- as.list(var_labels[match(names(data_octa_clockhour_rename), names(var_labels))])
```

##Data Dictionary

```{r}
# print html table
data_dict %>% 
  kable(col.names = c("Variable", "Label")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  pack_rows("Sociodemographic Variables", 2, 3) %>% 
  pack_rows("Systemic Clinical Variables", 4, 6) %>% 
  pack_rows("Ophthalmic Clinical Variables", 7, 12) %>% 
  pack_rows("OCT Angiography Variables", 13, 30) 
```

#Single Eye Participation

Venugopal (2019) et al. ran the analysis including all eyes.[@venugopalRepeatabilityComparabilityPeripapillary2019] Then they re-ran the analysis after selecting only a single eye randomly from each individual. They conclude minimal difference in the findings, and they report only the analysis that includes all eyes: 

"The entire analysis was repeated considering one eye per subject (one eye was randomly chosen from subjects contributing both eyes for the primary analysis) and all the results were similar to the primary analysis."[@venugopalRepeatabilityComparabilityPeripapillary2019]

The following results are for the single eye, chosen at random, from each participant. Bruce did explain a way to calculate ICC's for all measurements on both eyes of each participant. This will be coded later.

```{r}
# function that gets just one eye
get_1eye <- function(df){
  
  # set the seed so working with a consistent dataset when randomly sampling left or right eye
  set.seed(123456)
  
  # select random 1 eye per person
  select_1eye <- df %>% 
    # get 1 eyeid
    group_by(ptid, eyeid) %>% sample_n(1) %>% select(ptid, eyeid) %>% ungroup() %>% 
    # sample 1 eye per individual
    group_by(ptid) %>% sample_n(1) %>% ungroup() %>% select(eyeid)
  
  # subset just the eyes in the selection above
  df %>% 
    left_join(x = select_1eye, by = "eyeid")
  
}

# get_1eye(data_octa_global_rename) %>% glimpse

# dataset of one eye
data_octa_global_1eye <- data_octa_global_rename %>% get_1eye()
```

#Subsetting Cohorts

##Intra-Visit Data

Intra-visit data was restricted to all measurements of the same eye that occurred on the same day. Some people had multiple measurements on multiple days. Their first day was included only.

```{r}

# Intra-Visit Data: create a dataset that selects only repeat measurements per day
get_intra <- function(df){

  df %>% 
    
    # create variable that indicates when there is a repeat measurement on the same day for each eye
    add_count(ptid, eye_imaged, exam_date, name = "n_msr_day") %>%
    filter(n_msr_day > 1) %>%
    
    # now that all the days with single measurements have been excluded, pick the first date with multiple measurements
    group_by(ptid, eye_imaged) %>%
    filter(exam_date == min(exam_date)) %>%
    # create an indicator variable that shows the order of measurements
    mutate(order_obs = seq(n())) %>% 
    ungroup() %>% 
    
    # create an indicator variable that shows the order of measurements
    group_by(ptid, eye_imaged) %>% 
    mutate(order_obs = seq(n())) %>% 
    ungroup()    
  
}
 
# create intra dataset for global data 
data_octa_global_intra <- data_octa_global_1eye %>% get_intra()
```

##Inter-Visit Data

Inter-visit data was restricted to the first measurement of the day for each eye. If a patient had their right eye measured:    

- 3 times on Monday  

- 5 times on Wednesday, and  

- 2 times on Friday,  

Then they would have three observations in this dataset:

- The first measurement from Monday,  

- The first measurement from Wednesday, and  

- The first measurement from Friday.

```{r}
# Inter-Visit Data: create a dataset that selects the first measurement per day for each eye; there are no repeat measurements per day
get_inter <- function(df, window_days){
  
  df %>% 
    
    # select the first measurement per day for every eye imaged
    group_by(ptid, eye_imaged, exam_date) %>% 
    top_n(n = -1, wt = time_stamp) %>% 
    ungroup() %>% 
    
    # create an indicator variable that shows the order of measurements
    group_by(ptid, eye_imaged) %>% 
    mutate(order_obs = seq(n())) %>% 
    ungroup() %>% 
    
    # filter only measurements that are within 180 days of each other
    group_by(ptid, eye_imaged) %>% 
    # arrange by increasing exam_date, important for taking the difference in next line
    arrange(exam_date) %>% 
    mutate(
      # set the date of the first visit
      day_one = min(exam_date),
      # take the difference of the exam_date and the first visit
      diff_date = difftime(exam_date, day_one, units = "days"),
      # indicator variable of whether the time since first visit was within n days
      ind_n_day = ifelse(diff_date <= window_days, yes = 1, no = 0)
      ) %>% 
    # remove all observations that were not within the time window
    filter(ind_n_day == 1) %>%
    ungroup() %>% 
    
    # remove all people with just one baseline exam that made it through the filtering
    arrange(ptid) %>% 
    group_by(ptid, eye_imaged) %>% 
    mutate(n_exams = n()) %>% 
    filter(n_exams > 1) %>% 
    ungroup()
  
}

# create inter dataset for global data, infinite day window
data_octa_global_inter <- data_octa_global_1eye %>% get_inter(window_days = Inf)

# create inter dataset for global data, 365 day window
data_octa_global_inter365 <- data_octa_global_1eye %>% get_inter(window_days = 365.25)

# create inter dataset for global data, 180 day window
data_octa_global_inter180 <- data_octa_global_1eye %>% get_inter(window_days = 180)
```

##Data Flow Chart

This tallies how many participants, how many eyes, and how many measurements are included in the two datasets.

```{r}

data.frame(
  
  dataset = c(
    "Intra-Visit",
    "Inter-Visit"
    ),
  
  #number of participants
  n_participants = c(
    data_octa_global_intra %>% group_by(ptid) %>% summarise(n()) %>% nrow(),
    data_octa_global_inter %>% group_by(ptid) %>% summarise(n()) %>% nrow()
    ),
  
  #number of eyes
  n_eyes = c(
    data_octa_global_intra %>% group_by(ptid, eye_imaged) %>% summarise(n()) %>% nrow(),
    data_octa_global_inter %>% group_by(ptid, eye_imaged) %>% summarise(n()) %>% nrow()
    ),
  
  # number of measurements
  n_measurements = c(
    data_octa_global_intra %>% nrow(),
    data_octa_global_inter %>% nrow()
    )
  
  ) %>%
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  pack_rows("Global Data", 1, 2)
```

```{r}
# function to count observations for normal and glaucoma by eye and observation
get_count_obs <- function(df){
  count_data <- df %>% group_by(glc_dx_bin) %>% mutate(patients = n_distinct(ptid)) %>% count(patients)

  list(
    measurements = list(
      normal   = count_data$n[count_data$glc_dx_bin == "Normal"], 
      glaucoma = count_data$n[count_data$glc_dx_bin == "Glaucoma"]),
    patients = list(
      normal   = count_data$patients[count_data$glc_dx_bin == "Normal"], 
      glaucoma = count_data$patients[count_data$glc_dx_bin == "Glaucoma"])
  )}

count <- get_count_obs(data_octa_global_1eye)

count_intra <- get_count_obs(data_octa_global_intra)

count_inter <- get_count_obs(data_octa_global_inter)
```

**Overall** there were:

- `r count$measurements$normal` measurements of `r count$patients$normal` patients without glaucoma

- `r count$measurements$glaucoma` measurements of `r count$patients$glaucoma` patients with glaucoma

Among **intravisit** data there were:

- `r count_intra$measurements$normal` measurements of `r count_intra$patients$normal` patients without glaucoma

- `r count_intra$measurements$glaucoma` measurements of `r count_intra$patients$glaucoma` patients with glaucoma

Among **intervisit** data there were:

- `r count_inter$measurements$normal` measurements of `r count_inter$patients$normal` patients without glaucoma

- `r count_inter$measurements$glaucoma` measurements of `r count_inter$patients$glaucoma` patients with glaucoma


#Table 1: Summary Statistics

<span style="color:red">Note to Dom: Something weird is occuring with Table 1...need to debug because it shows 82 glaucoma patients, but we're saying only 81 when looking directly at the data (above).</span> 

```{r}
# function to get table 1 for individual people, no repeated measurements
print_table1_people <- function(df){
 
  vars_systemic <- c("age", "female", "htn_dx", "dm_dx", "nro_dx")
  vars_new <- c("glc_dx_bin", "dr_dx_bin", "surg_proc_catextract", "surg_proc_glaucoma", "signal_strength")
  
  # vars in table 1
  Vars_table1 <- c(vars_systemic, vars_new)

  # dataframe for table 1
  df_table1 <- df %>% 
    # format doubles so not categorical
    mutate(
      age = as.double(age),
      ptid = as.double(ptid),
      eyeid = as.double(eyeid),
      glc_dx_bin = as.double(glc_dx_bin),
      dr_dx_bin = as.double(dr_dx_bin),
      signal_strength = as.double(signal_strength),
      surg_proc_catextract = as.double(surg_proc_catextract),
      surg_proc_glaucoma = as.double(surg_proc_glaucoma)
      ) %>%
    # select(ptid, order_obs, age) %>% 
    pivot_wider(
      id_cols = c(ptid, vars_systemic),
      names_prefix = "obs_",
      names_from = c(eye_imaged, order_obs),
      values_from = c(glc_dx_bin, dr_dx_bin, signal_strength, surg_proc_glaucoma, surg_proc_catextract)
    ) %>% 
    mutate(
      
      signal_strength = rowMeans(select(., starts_with("signal_strength")), na.rm = TRUE) %>% as.double(),
      
      glc_dx_bin = case_when(
        glc_dx_bin_obs_Right_1 == 1 | glc_dx_bin_obs_Right_2 == 1 | glc_dx_bin_obs_Right_3 == 1 |
         glc_dx_bin_obs_Left_1 == 1 |  glc_dx_bin_obs_Left_2 == 1 |  glc_dx_bin_obs_Left_3 == 1 ~ 1,
        glc_dx_bin_obs_Right_1 == 2 | glc_dx_bin_obs_Right_2 == 2 | glc_dx_bin_obs_Right_3 == 2 |
         glc_dx_bin_obs_Left_1 == 2 |  glc_dx_bin_obs_Left_2 == 2 |  glc_dx_bin_obs_Left_3 == 2 ~ 2
      ) %>% form_glc_bin(),
      
      dr_dx_bin = case_when(
        dr_dx_bin_obs_Right_1 == 1 | dr_dx_bin_obs_Right_2 == 1 | dr_dx_bin_obs_Right_3 == 1 |
         dr_dx_bin_obs_Left_1 == 1 |  dr_dx_bin_obs_Left_2 == 1 |  dr_dx_bin_obs_Left_3 == 1 ~ 1,
        dr_dx_bin_obs_Right_1 == 2 | dr_dx_bin_obs_Right_2 == 2 | dr_dx_bin_obs_Right_3 == 2 |
         dr_dx_bin_obs_Left_1 == 2 |  dr_dx_bin_obs_Left_2 == 2 |  dr_dx_bin_obs_Left_3 == 2 ~ 2
      ) %>% form_ny(),
      
      surg_proc_catextract = case_when(
        surg_proc_catextract_obs_Right_1 == 1 | surg_proc_catextract_obs_Right_2 == 1 | surg_proc_catextract_obs_Right_3 == 1 |
         surg_proc_catextract_obs_Left_1 == 1 |  surg_proc_catextract_obs_Left_2 == 1 |  surg_proc_catextract_obs_Left_3 == 1 ~ 1,
        surg_proc_catextract_obs_Right_1 == 2 | surg_proc_catextract_obs_Right_2 == 2 | surg_proc_catextract_obs_Right_3 == 2 |
         surg_proc_catextract_obs_Left_1 == 2 |  surg_proc_catextract_obs_Left_2 == 2 |  surg_proc_catextract_obs_Left_3 == 2 ~ 2
      ) %>% form_ny(),
      
      # "None", "Laser", "Minimally Invasive Glaucoma Surgery", "Filter"
      surg_proc_glaucoma = case_when(
        surg_proc_glaucoma_obs_Right_1 == 4 | surg_proc_glaucoma_obs_Right_2 == 4 | surg_proc_glaucoma_obs_Right_3 == 4 |
         surg_proc_glaucoma_obs_Left_1 == 4 |  surg_proc_glaucoma_obs_Left_2 == 4 |  surg_proc_glaucoma_obs_Left_3 == 4 ~ 4,
        surg_proc_glaucoma_obs_Right_1 == 3 | surg_proc_glaucoma_obs_Right_2 == 3 | surg_proc_glaucoma_obs_Right_3 == 3 |
         surg_proc_glaucoma_obs_Left_1 == 3 |  surg_proc_glaucoma_obs_Left_2 == 3 |  surg_proc_glaucoma_obs_Left_3 == 3 ~ 3,
        surg_proc_glaucoma_obs_Right_1 == 2 | surg_proc_glaucoma_obs_Right_2 == 2 | surg_proc_glaucoma_obs_Right_3 == 2 |
         surg_proc_glaucoma_obs_Left_1 == 2 |  surg_proc_glaucoma_obs_Left_2 == 2 |  surg_proc_glaucoma_obs_Left_3 == 2 ~ 2,
        surg_proc_glaucoma_obs_Right_1 == 1 | surg_proc_glaucoma_obs_Right_2 == 1 | surg_proc_glaucoma_obs_Right_3 == 1 |
         surg_proc_glaucoma_obs_Left_1 == 1 |  surg_proc_glaucoma_obs_Left_2 == 1 |  surg_proc_glaucoma_obs_Left_3 == 1 ~ 1
      ) %>% form_surg()
      
    ) %>% 
    select(-ends_with("_1"), -ends_with("_2"), -ends_with("_3"))
  
  # add labels from data dictionary
  label(df_table1) <- as.list(var_labels[match(names(df_table1), names(var_labels))])
  
  # format variables for table 1
  df_table1 <- df_table1 %>% 
    mutate(
      age = as.double(age),
      signal_strength = as.double(signal_strength)
    )
  
    ## export table 1 to html
    CreateTableOne(data = df_table1, vars = Vars_table1, strata = "glc_dx_bin") %>%
      print(exact = "stage", quote = FALSE, noSpaces = F, printToggle = F, varLabels = T) %>%
      kableone(digits = 3) %>%
      kable_styling(
        #bootstrap table classes
        bootstrap_options = c("striped", "hover")
      ) %>%
      pack_rows("Sociodemographic Variables", 2, 3) %>%
      pack_rows("Systemic Clinical Variables", 4, 6) %>%
      pack_rows("Ophthalmic Clinical Variables", 7, 8) %>% 
      pack_rows("Ophthalmic Surgical Variables", 9, 14) %>% 
      pack_rows("OCT Angiography Signal Strength", 15, 15)

}
# print_table1_people(data_octa_global_intra)
# data_octa_global_intra %>% glimpse
```


```{r}
# function to get table 1 for all, repeated measurements
print_table1_measure <- function(df){
  
  # variables to be included
  Vars_table1 <- c(
    "age", "female", 
    "htn_dx", "dm_dx", "nro_dx", 
    "dr_dx", "glc_sus_dx", "glc_dx", "surg_proc_glaucoma", "surg_proc_catextract",
    "eye_imaged", "image_area", "image_method", "image_size", "signal_strength",
    "v_diameter", "v_area_density", "zeiss_v_area_density", "v_skeleton_density", "v_perimeter_index", "v_complexity_index",
    "flow_impair_zone", "flux", "zeiss_flux" 
  )
  # variables not included
  # "eyeid", "ptid", "name_last", "name_first", "time_stamp", "exam_date"
  
  # factor variables
  catVars_table1 <- c("female", "eye_imaged", "image_area", "image_method", "image_size")
  
  # exclude the following from table1: -SID, -Target, -Judge, -Date, -Meds, -Sx, -GLC
  df_table1 <- df %>% select(Vars_table1, "glc_dx_bin") %>% mutate(
    age = as.double(age),
    v_diameter = as.double(v_diameter),
    v_area_density = as.double(v_area_density),
    zeiss_v_area_density = as.double(zeiss_v_area_density),
    v_skeleton_density = as.double(v_skeleton_density),
    v_perimeter_index = as.double(v_perimeter_index),
    v_complexity_index = as.double(v_complexity_index),
    flow_impair_zone = as.double(flow_impair_zone),
    flux = as.double(flux),
    zeiss_flux = as.double(zeiss_flux)
  )
  
    ## export table 1 to html
    CreateTableOne(data = df_table1, vars = Vars_table1, factorVars = catVars_table1, strata = "glc_dx_bin") %>% 
      print(exact = "stage", quote = FALSE, noSpaces = F, printToggle = F, varLabels = T) %>%
      kableone(digits = 3) %>%
      kable_styling(
        #bootstrap table classes
        bootstrap_options = c("striped", "hover")
      ) %>% 
      pack_rows("Sociodemographic Variables", 2, 3) %>%
      pack_rows("Systemic Clinical Variables", 4, 6) %>% 
      pack_rows("Diabetic Retinopathy Diagnosis", 7, 12) %>% 
      pack_rows("Glaucoma Suspect Diagnosis", 13, 17) %>%
      pack_rows("Glaucoma Diagnosis, Ordinal", 18, 22) %>%
      pack_rows("Surgical Procedure for Glaucoma", 23, 27) %>%
      pack_rows("Surgical Procedure for Cataract Extraction", 28, 28) %>% 
      pack_rows("Image Specifications", 29, 32) %>% 
      pack_rows("OCT Angiography Signal Strength", 33, 37) %>% 
      pack_rows("OCT Angiography Variables", 38, 46)
    
}
# print_table1(data_octa_global_intra)
```

##Intra-Visit OCTA Summary Statistics{.tabset}

Variables in intra-visit dataset

###Participants
```{r, message = FALSE}
print_table1_people(data_octa_global_intra)
```


###Measurements
```{r, warning = FALSE}
print_table1_measure(data_octa_global_intra)
```

##Inter-Visit OCTA Summary Statistics{.tabset}

Variables in inter-visit dataset

###Participants
```{r, message = FALSE}
print_table1_people(data_octa_global_inter)
```

###Measurements
```{r}
print_table1_measure(data_octa_global_inter)
```


#Exploratory Data Analysis

##Scatter Plots{.tabset}

Scatter plots of OCTA variables by Subject ID for about 10 individuals randomly sampled. These are separated by intra- and inter-visit datasets, and are useful for understanding the data better.

```{r}

scat_octa_sid <- function(octa_var){

  # select a random sample of 10 SID's
  set.seed(1998)
  ptid_sample10 <- data_octa_global_1eye %>% dplyr::filter(eye_imaged == "Right") %>% select(ptid) %>% sample_n(10) %>% unlist() %>% as.character()
  
grid.arrange(ncol = 2, left = var_labels[octa_var], top = "OCTA Measures by Patient", bottom = var_labels["ptid"],

             data_octa_global_intra %>%
               dplyr::filter((ptid %in% ptid_sample10) & (eye_imaged == "Right")) %>%
               ggplot(aes_string(x = "ptid", y = octa_var, group = "ptid")) +
               geom_point(alpha = 0.1, size = 5, color = "red") +
               ylim(min(data_octa_global_1eye[[octa_var]]), max(data_octa_global_1eye[[octa_var]])) +
               ggtitle("Intra") +
               ylab("") +
               xlab("") +
               theme(
                 legend.position = "none",
                 plot.title = element_text(hjust = 0.5),
                 axis.text.x = element_text(angle = 30, hjust = 1, size = 7)
                 ),
             
             data_octa_global_inter %>%
               dplyr::filter((ptid %in% ptid_sample10) & (eye_imaged == "Right")) %>%
               ggplot(aes_string(x = "ptid", y = octa_var, group = "ptid")) +
               geom_point(alpha = 0.1, size = 5, color = "blue") +
               ylim(min(data_octa_global_1eye[[octa_var]]), max(data_octa_global_1eye[[octa_var]])) +
               ggtitle("Inter") +
               ylab("") +
               xlab("") +
               theme(
                 legend.position = "none",
                 plot.title = element_text(hjust = 0.5),
                 axis.text.x = element_text(angle = 30, hjust = 1, size = 7)
                 )
)
}
```

###Vessel Area Density
```{r}
scat_octa_sid("v_area_density")
```

###Vessel Area Density, Zeiss
```{r}
scat_octa_sid("zeiss_v_area_density")
```

###Vessel Diameter
```{r}
scat_octa_sid("v_diameter")
```

###Vessel Skeleton Density
```{r}
scat_octa_sid("v_skeleton_density")
```

###Vessel Perimeter Index
```{r}
scat_octa_sid("v_perimeter_index")
```

###Vessel Complexity Index
```{r}
scat_octa_sid("v_complexity_index")
```

###Flow Impairment Zone
```{r}
scat_octa_sid("flow_impair_zone")
```

###Flux
```{r}
scat_octa_sid("flux")
```

###Flux, Zeiss
```{r}
scat_octa_sid("zeiss_flux")
```

##Spaghetti Plots{.tabset}

Spaghetti plots of OCTA variables for about 10 individuals randomly sampled.

```{r}

spaghet_plot <- function(octa_var){

  # select a random sample of 10 patients
  set.seed(2448)
  ptid_sample10 <- data_octa_global_1eye %>% dplyr::filter(eye_imaged == "Right") %>% select(ptid) %>% sample_n(10) %>% unlist() %>% as.character()
  
  # function that creates the plot
  get_plot_spaghet <- function(df, title, line_color){
    df %>%
      dplyr::filter((ptid %in% ptid_sample10) & (eye_imaged == "Right")) %>%
      ggplot(aes_string(x = "time_stamp", y = octa_var, group = "ptid")) +
      geom_line(alpha = 0.5, size = 1, color = line_color) +
      theme(legend.position = "none") +
      ylim(min(data_octa_global_1eye[[octa_var]]), max(data_octa_global_1eye[[octa_var]])) +
      ggtitle(title) +
      ylab("") +
      xlab("") +
      theme(
        legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 30, hjust = 1, size = 7)
      )
  }

grid.arrange(ncol = 2, left = var_labels[octa_var], top = "OCTA Measures Over Time", bottom = var_labels["time_stamp"],

  get_plot_spaghet(df = data_octa_global_intra, title = "Intra", line_color = "red"),
  get_plot_spaghet(df = data_octa_global_inter, title = "Inter", line_color = "blue")

)
  
}

# spaghet_plot("v_area_density")
```

###Vessel Area Density
```{r}
spaghet_plot("v_area_density")
```

###Vessel Area Density, Zeiss
```{r}
spaghet_plot("zeiss_v_area_density")
```

###Vessel Diameter
```{r}
spaghet_plot("v_diameter")
```

###Vessel Skeleton Density
```{r}
spaghet_plot("v_skeleton_density")
```

###Vessel Perimeter Index
```{r}
spaghet_plot("v_perimeter_index")
```

###Vessel Complexity Index
```{r}
spaghet_plot("v_complexity_index")
```

###Flow Impairment Zone
```{r}
spaghet_plot("flow_impair_zone")
```

###Flux
```{r}
spaghet_plot("flux")
```

###Flux, Zeiss
```{r}
spaghet_plot("zeiss_flux")
```

#Bland-Altman Plots

Coding of Bland-Altman (BA) plots is explained in this [blog post](https://www.r-bloggers.com/bland-altmantukey-mean-difference-plots-using-ggplot2/).


##Intra-Visit Bland-Altman Plots{.tabset}

Intra-Visit Bland-Altman Plots of OCTA Variables


```{r, warning = FALSE}

# function that gets repeatability statistics
get_blandaltman <- function(df, octa_var){

  # make OCTA variable name
  octa_name_df <- df %>% mutate(label = label(!!octa_var))
  octa_name <- octa_name_df[1, "label"] %>% as.character()
  
  # intra-visit dataset
  data_blandalt <- df %>%

    # select only the measurement ID and the OCTA variable of interest
    select(ptid, eye_imaged, order_obs, eyeid, !!octa_var) %>%
        
    # only select the first 2 measurements
    filter(order_obs <= 2) %>% 

    group_by(ptid, eye_imaged) %>% 

    # calculate the difference and mean of measurements for each individual eye
    mutate(
      diff = diff(!!octa_var),
      mean = mean(!!octa_var)
      ) %>% ungroup() %>% 
    select(!!octa_var, everything())

  p_blandalt <- data_blandalt %>%
    ggplot(aes(x = mean, y = diff)) +
    scale_y_continuous(limits = c(-max(data_blandalt$diff)*1.5, max(data_blandalt$diff)*1.5)) +
    geom_point(size = 0.6, alpha = 0.9) +
    geom_hline(yintercept = mean(data_blandalt$diff), colour = "blue", size = 0.5, linetype = 2) +
    geom_hline(yintercept = mean(data_blandalt$diff) - (1.96 * sd(data_blandalt$diff)), colour = "red", size = 0.5, linetype = 2) +
    geom_hline(yintercept = mean(data_blandalt$diff) + (1.96 * sd(data_blandalt$diff)), colour = "red", size = 0.5, linetype = 2) +
    geom_text(aes(label = ifelse(
      diff >  mean(data_blandalt$diff) + (1.96 * sd(data_blandalt$diff)) |
      diff <  mean(data_blandalt$diff) - (1.96 * sd(data_blandalt$diff)),
        yes = as.character(eyeid), no = ''
      )), hjust = 0, vjust = 0, color = "darkgray", size = 3) +
    ggtitle("") +
    ylab("Difference in Measurements") +
    xlab("Average Measurements")

  p_diffdist <- data_blandalt %>%
    ggplot(aes(x = diff)) +
    geom_vline(xintercept = mean(data_blandalt$diff), colour = "blue", size = 0.5, linetype = 2) +
    geom_vline(xintercept = mean(data_blandalt$diff) - (1.96 * sd(data_blandalt$diff)), colour = "red", size = 0.5, linetype = 2) +
    geom_vline(xintercept = mean(data_blandalt$diff) + (1.96 * sd(data_blandalt$diff)), colour = "red", size = 0.5, linetype = 2) +
    geom_histogram(bins = 30, alpha = 0.9) +
    geom_text(aes(label = ifelse(
      diff >  mean(data_blandalt$diff) + (1.96 * sd(data_blandalt$diff)) |
      diff <  mean(data_blandalt$diff) - (1.96 * sd(data_blandalt$diff)),
        yes = as.character(eyeid), no = ''
      ), y = 6), hjust = 0, vjust = 0, color = "darkgray", size = 3) +
    scale_y_continuous(limits = c(0, 200), breaks = seq(0,200,50)) +
    scale_x_continuous(limits = c(-max(data_blandalt$diff)*1.5, max(data_blandalt$diff)*1.5)) +
    ggtitle("") +
    xlab("Difference in Measurements")

  grid.arrange(ncol = 2, top = octa_name, p_blandalt, p_diffdist)
}

# get_blandaltman(df = data_octa_global_intra, octa_var = quo(v_area_density))
```


###Vessel Area Density
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_intra, octa_var = quo(v_area_density))
```

###Vessel Area Density, Zeiss
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_intra, octa_var = quo(zeiss_v_area_density))
```

###Vessel Diameter
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_intra, octa_var = quo(v_diameter))
```

###Vessel Skeleton Density
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_intra, octa_var = quo(v_skeleton_density))
```

###Vessel Perimeter Index
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_intra, octa_var = quo(v_perimeter_index))
```

###Vessel Complexity Index
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_intra, octa_var = quo(v_complexity_index))
```

###Flow Impairment Zone
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_intra, octa_var = quo(flow_impair_zone))
```

###Flux
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_intra, octa_var = quo(flux))
```

###Flux, Zeiss
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_intra, octa_var = quo(zeiss_flux))
```

###Outliers

Assess some of the observations outside of expected limits.

```{r}
potential_outliers <- c(92, 95, 39, 220, 192, 183, 171, 40, 232, 21, 58, 143, 40, 183, 18, 208, 192, 21, 130, 174, 11, 171, 192, 183, 92, 95)

data_octa_global_intra %>% 
  filter(eyeid %in% potential_outliers) %>% 
  select(eyeid,	ptid, signal_strength, everything()) %>% 
  kable(digits = 3) %>%
  kable_styling(
    #bootstrap table classes
    bootstrap_options = c( "hover")
  )
```


##Inter-Visit Bland-Altman Plots{.tabset}

Inter-Visit Bland-Altman Plots of OCTA Variables

###Vessel Area Density
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_inter, octa_var = quo(v_area_density))
```

###Vessel Area Density, Zeiss
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_inter, octa_var = quo(zeiss_v_area_density))
```

###Vessel Diameter
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_inter, octa_var = quo(v_diameter))
```

###Vessel Skeleton Density
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_inter, octa_var = quo(v_skeleton_density))
```

###Vessel Perimeter Index
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_inter, octa_var = quo(v_perimeter_index))
```

###Vessel Complexity Index
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_inter, octa_var = quo(v_complexity_index))
```

###Flow Impairment Zone
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_inter, octa_var = quo(flow_impair_zone))
```

###Flux
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_inter, octa_var = quo(flux))
```

###Flux, Zeiss
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_inter, octa_var = quo(zeiss_flux))
```


###Outliers

Assess some of the observations outside of expected limits.

```{r}
data_octa_global_inter %>% 
  filter(eyeid %in% c(42, 75, 82, 92, 220, 232, 244)) %>% 
  select(eyeid,	ptid, signal_strength, everything()) %>% 
  kable(digits = 3) %>%
  kable_styling(
    #bootstrap table classes
    bootstrap_options = c( "hover")
  )
```

#Repeatability

Repeatability of OCTA Variables

Calculate the within-subject standard deviation $(S_w)$, the within-subject coefficient of repeatability $(CR_w)$, and the within-subject coefficient of variation $(CV_w)$ for a given measurement variable $x$.  

```{r, include = FALSE}

# I tried to calculate the Sw manually and by using the one-way anova table, as instructed in Bland (1996). However, the two methods are producing different answers for Sw. Therefore, try to use the data in the paper to recalculate Sw for the sample data provided.

# after rechecking, it turns out my calculations were correct, but it's just the rounding errors combined with squaring and square-rooting to go from standard deviation to variance that caused the differences.

# data copied from Bland (1996)
df_bland96 <- matrix(c(190, 220, 200, 200, 202.50, 12.58, 220, 200, 240, 230, 222.50, 17.08, 260, 260, 240, 280, 260.00, 16.33, 210, 300, 280, 265, 263.75, 38.60, 270, 265, 280, 270, 271.25, 6.29, 280, 280, 270, 275, 276.25, 4.79, 260, 280, 280, 300, 280.00, 16.33, 275, 275, 275, 305, 282.50, 15.00, 280, 290, 300, 290, 290.00, 8.16, 320, 290, 300, 290, 300.00, 14.14, 300, 300, 310, 300, 302.50, 5.00, 270, 250, 330, 370, 305.00, 55.08, 320, 330, 330, 330, 327.50, 5.00, 335, 320, 335, 375, 341.25, 23.58, 350, 320, 340, 365, 343.75, 18.87, 360, 320, 350, 345, 343.75, 17.02, 330, 340, 380, 390, 360.00, 29.44, 335, 385, 360, 370, 362.50, 21.02, 400, 420, 425, 420, 416.25, 11.09, 430, 460, 480, 470, 460.00, 21.60), ncol = 6, byrow = T, dimnames = list(c(), c("1st", "2nd", "3rd", "4th", "Mean", "SD"))) %>%
  # convert to dataframe
  as.data.frame() %>%
  # make a column of children ID
  mutate(children = seq(1:20)) %>% select(children, everything())

# calculate the values manually
df_bland96 %>%
  # take the average of mean measurements and the average of the variances
  summarise(
    Xw = mean(Mean),
    Sw = sqrt(mean(SD^2))
    ) %>%
  # square root the variances
  mutate(
    CRw = sqrt(2)*1.96*Sw,
    CVw = 100*Sw/Xw
    )

df_bland96 %>%
  select(children, `1st`, `2nd`, `3rd`, `4th`) %>% mutate(children = factor(children)) %>%
  gather(key = measurement, value = value, -children) %>%
  # select only the eye ID, the eye ID, and the OCTA variable of interest
  aov(formula = value ~ children)
```

##Table 2: Repeatability

Table 2 shows repeatability estimates of vessel density measurements.

<span style="color:blue">This table was modeled after Table 2 in Venugopal (2018).[@venugopalRepeatabilityVesselDensity2018]</span> 

```{r}
# function that gets repeatability statistics
get_repeatability <- function(df, octa_var){

trim3 <- function(x){sprintf("%.3f", round(x, 3))}

  # make OCTA variable name
  octa_name <- var_labels[as_label(octa_var)]
  
  # intra-visit dataset
  df %>%

    # select only the measurement ID and the OCTA variable of interest
    select(ptid, eyeid, eye_imaged, order_obs, !!octa_var) %>%

    # group by measurement ID
    group_by(eyeid) %>%

    # calculate the mean and variance of measurements for each individual
    mutate(
      mean = base::mean(!!octa_var),
      var = stats::sd(!!octa_var)^2
      ) %>%

    # remove grouping by measurement ID
    ungroup() %>%

    # take the average of mean measurements and the average of the variances
    summarise(
      n = n(),
      Âµ = mean(mean),
      Sw = sqrt(mean(var)),
      se_var = sd(var)/sqrt(n()),
      sw_95l = Sw - 1.96*se_var,
      sw_95u = Sw + 1.96*se_var
      ) %>%

    # square root the variances
    mutate(
      
      CRw = sqrt(2)*1.96*Sw,
      CRw_95l = sqrt(2)*1.96*sw_95l,
      CRw_95u = sqrt(2)*1.96*sw_95u,
      
      CVw = 100*Sw/Âµ,
      CVw_95l = 100*sw_95l/Âµ,
      CVw_95u = 100*sw_95u/Âµ,

      var_name = octa_name
      
      ) %>%
    
    # make the variables pretty\
    
    mutate(
      Sw_pretty = trim3(Sw),
      Sw_pretty_cl = paste0("(", trim3(sw_95l), ", ", trim3(sw_95u), ")"),
      CRw_pretty = trim3(CRw),
      CRw_pretty_cl = paste0("(", trim3(CRw_95l), ", ", trim3(CRw_95u), ")"),
      CVw_pretty = trim3(CVw),
      CVw_pretty_cl = paste0("(", trim3(CVw_95l), ", ", trim3(CVw_95u), ")")
    ) %>% 
    
    # remove ugly variables
    select(
      -Sw, -se_var, -sw_95l, -sw_95u,
      -CRw, -CRw_95l, -CRw_95u,
      -CVw, -CVw_95l, -CVw_95u
      ) %>% 
    
    select(var_name, everything())

}

get_repeat_table <- function(df_table){
  
  # call repeatability statistics on each measurement, then make into a table
  get_repeatability(df = df_table, octa_var = quo(v_diameter)) %>%
    rbind(
      get_repeatability(df = df_table, octa_var = quo(v_area_density)),
      get_repeatability(df = df_table, octa_var = quo(zeiss_v_area_density)),
      get_repeatability(df = df_table, octa_var = quo(v_skeleton_density)),
      get_repeatability(df = df_table, octa_var = quo(v_perimeter_index)),
      get_repeatability(df = df_table, octa_var = quo(v_complexity_index)),
      get_repeatability(df = df_table, octa_var = quo(flow_impair_zone)),
      get_repeatability(df = df_table, octa_var = quo(flux)),
      get_repeatability(df = df_table, octa_var = quo(zeiss_flux))
    ) 

}

get_repeat_kable <- function(df_kable){
  
  df_kable %>% 
    
    # make html "kable" and round digits
    kable(digits = 3, col.names = c("OCTA Variable", "n_measure", "Âµ", "Sw", "Sw 95% CL", "CRw", "CRw 95% CL", "CVw", "CVw 95% CL")) %>%
    kable_styling(
      #bootstrap table classes
      bootstrap_options = c( "hover")
    )
}
```

###Intra-Visit Repeatability{.tabset}

####Normal
```{r}
data_octa_global_intra %>%
  filter(glc_dx_bin == "Normal") %>% 
  get_repeat_table() %>% 
  get_repeat_kable()
```

####Glaucoma
```{r}
data_octa_global_intra %>%
  filter(glc_dx_bin == "Glaucoma") %>% 
  get_repeat_table() %>% 
  get_repeat_kable()
```

###Inter-Visit Repeatability{.tabset}

Restrict to repeat measurements within the last 6 months.

####Normal, 180 Days

There are way too few measurements for this table to be reliable.

```{r}
data_octa_global_inter %>%
  get_inter(180) %>% 
  filter(glc_dx_bin == "Normal") %>% 
  get_repeat_table() %>% 
  get_repeat_kable()
```

####Glaucoma, 180 Days
```{r}
data_octa_global_inter %>%
  get_inter(180) %>% 
  filter(glc_dx_bin == "Glaucoma") %>% 
  get_repeat_table() %>% 
  get_repeat_kable()
```

##Calculating Repeatability Statistics

Explanations of repeatability statistic calculations  

###Within-Subject Mean $(\mu_w)$

$\mu_w$ is the average of all measurements of one eye for a given individual. The overall mean $(\mu)$ is calculated by taking the mean of $\mu_w$ across the dataset. The overall mean is included in the final table for reference.

\[ \mu_w = \frac{1}{M}\sum_{i=1}^{M} x_i  \]

\[\text{where } M \text{ is the number of measurements per eye,}\]

###Within-Subject Standard Deviation $(S_w)$

Find $S_w$ by first calculating the variance of the measurements per individual eye. The equation below is general for any number of measurements; in this study there are at least 2 measurements per eye, but sometimes more.  

\[ \sigma^2_{measurement} =  \frac{1}{M}\sum_{i=1}^{M} (x_i - \mu_w)^2 \]

\[ \text{where } M \text{ is the number of measurements per eye}  \]

To calculate $S_w$, average of the variance of measurements $(\sigma^2_{measurement})$ for all eyes measured, then take the square root.  

\[ Sw =  \sqrt{\frac{1}{N}\sum_{i=1}^{N}\sigma^2_{measurement,i}} \]

\[ \text{where } N \text{ is the number of eyes measured} \]

###Within-Subject Coefficient of Repeatability $(CR_w)$

The $CR_w$ provides the uncertainty of repeated measures.

\[ CRw = \sqrt2 * 1.96 * Sw \]

The $CR_w$ can be interpreted as:  

"The difference between two measurements for the same subject is expected to be less than [$CR_w$] for 95% of pairs of observations."[@blandStatisticsNotesMeasurement1996]

###Within-Subject Coefficient of Variation $(CV_w)$

\[ CVw = 100 *\frac{Sw}{\mu} \]


#Intraclass Correlation Coefficient, Unadjusted

Intraclass Correlation Coefficient (ICC) is scored using the **ICCest()** function from the **ICC** package. This function "estimates the ICC and confidence intervals using the variance components from a one-way ANOVA."

This is a preliminary result, as we want to calculate the ICC after adjusting for participant, eye (left or right), signal strength, and clinical and other variables. This will be done later in the mixed effects regression models.

```{r}
# function that produces a kable output for internal datasets
icc_tabulate <- function(df){

  library(ICC)
  
  trim3 <- function(x){sprintf("%.3f", round(as.double(x), 3))}

  # function that calls ICC function, adds a column to front with variable name
  icc_that <- function(df, var){
      c(var, ICCest(eyeid, var, data = df))
  }

  # call the ICC function on each OCTA variable, then r bind into a table
  rbind(
    icc_that(df, "v_diameter"),
    icc_that(df, "v_area_density"),
    icc_that(df, "zeiss_v_area_density"),
    icc_that(df, "v_skeleton_density"),
    icc_that(df, "v_perimeter_index"),
    icc_that(df, "v_complexity_index"),
    icc_that(df, "flow_impair_zone"),
    icc_that(df, "flux"),
    icc_that(df, "zeiss_flux")
  ) %>% as.data.frame() %>%
    # round columns
    mutate(
      V1 = var_labels[as.character(V1)],
      ICC = as.double(ICC),
      k = as.double(k),
      varw = as.double(varw),
      vara = as.double(vara),
      
      ICC_pretty = trim3(ICC),
      ICC_pretty_cl = paste0("(", trim3(LowerCI), ", ", trim3(UpperCI), ")")
      ) %>% 
    
    # remove unweildy variables
    select(-ICC, -LowerCI, -UpperCI) %>% 
    # order desirably
    select(V1, N, ICC_pretty, ICC_pretty_cl, everything())


}

icc_tabulate_kable <- function(df_kable){
  
  df_kable %>% 
    # call kable
    kable(digit = 3, col.names = c("OCTA Variable", "n_people", "ICC", "ICC 95% CL", "k", "varw", "vara")) %>%
    #bootstrap table classes
    kable_styling(bootstrap_options = c("striped", "hover"))
  
}
```


##Intra-Visit ICC, Unadjusted{.tabset}

###Normal
```{r, warning=FALSE}
data_octa_global_intra %>%
  filter(glc_dx_bin == "Normal") %>% 
  icc_tabulate() %>% 
  icc_tabulate_kable
```

###Glaucoma
```{r, warning=FALSE}
data_octa_global_intra %>%
  filter(glc_dx_bin == "Glaucoma") %>% 
  icc_tabulate() %>% 
  icc_tabulate_kable
```


##Inter-Visit ICC, Unadjusted

###Inter-Visit ICC Normal{.tabset}

####Normal, All
```{r, warning=FALSE}
data_octa_global_inter %>%
  filter(glc_dx_bin == "Normal") %>% 
  icc_tabulate() %>% 
  icc_tabulate_kable
```

####Normal, 365 Days
```{r, warning=FALSE}
data_octa_global_inter365 %>%
  filter(glc_dx_bin == "Normal") %>% 
  icc_tabulate() %>% 
  icc_tabulate_kable
```

####Normal, 180 Days
```{r, warning=FALSE}
data_octa_global_inter180 %>%
  filter(glc_dx_bin == "Normal") %>% 
  icc_tabulate() %>% 
  icc_tabulate_kable
```

###Inter-Visit ICC Glaucoma{.tabset}

####Glaucoma
```{r, warning=FALSE}
data_octa_global_inter %>%
  filter(glc_dx_bin == "Glaucoma") %>% 
  icc_tabulate() %>% 
  icc_tabulate_kable
```

####Glaucoma, 365 Days
```{r, warning=FALSE}
data_octa_global_inter365 %>%
  filter(glc_dx_bin == "Glaucoma") %>% 
  icc_tabulate() %>% 
  icc_tabulate_kable
```

####Glaucoma, 180 Days
```{r, warning=FALSE}
data_octa_global_inter180 %>%
  filter(glc_dx_bin == "Glaucoma") %>% 
  icc_tabulate() %>% 
  icc_tabulate_kable
```


##Calculating ICC Statistic

\[ \text{ICC} = \frac{\text{between}}{\text{between} + \text{within}}\]

<span style="color:blue">"In the output for the random effects model â€˜SIDâ€™ is the estimated between-group variance, which in the ICCest output is called â€˜varaâ€™ (variance among groups). The within-group variance is â€˜Residualâ€™ in the random effects model output, while in ICCest itâ€™s called â€˜varw.â€™ You can see that the values for those two variances match perfectly in the two different outputs. The ICC is defined as between/(between+within). That calculation is not part of the random effects model output, but it is part of the ICCest output, along with confidence intervals for the ICC estimate. The ICC are really high for intravisit (around 97%) and a little lower for intervisit (about 94%). If we were to calculate these ICC for glaucoma and controls separately I think they would be significantly lower because of the reduced between-group variability." - BB 9/4/2019</span> 

#ARVO Abstract Tables

##Table 1: Participants

**Overall** there were:

- `r count$measurements$normal` measurements of `r count$patients$normal` patients without glaucoma

- `r count$measurements$glaucoma` measurements of `r count$patients$glaucoma` patients with glaucoma

Among **intravisit** data there were:

- `r count_intra$measurements$normal` measurements of `r count_intra$patients$normal` patients without glaucoma

- `r count_intra$measurements$glaucoma` measurements of `r count_intra$patients$glaucoma` patients with glaucoma

Among **intervisit** data there were:

- `r count_inter$measurements$normal` measurements of `r count_inter$patients$normal` patients without glaucoma

- `r count_inter$measurements$glaucoma` measurements of `r count_inter$patients$glaucoma` patients with glaucoma

```{r}
print_table1_people(data_octa_global_intra)
```

##Table 2: Repeatability Statistics

```{r, warning = FALSE}
octa_vars_select_vars <- c("v_area_density", "zeiss_v_area_density", "flux", "zeiss_flux", "v_skeleton_density")
octa_vars_select_labels <- var_labels[octa_vars_select_vars]

normal_repeat <- bind_cols(
data_octa_global_intra %>%
  filter(glc_dx_bin == "Normal") %>% 
  get_repeat_table(),
data_octa_global_intra %>%
  filter(glc_dx_bin == "Normal") %>% 
  icc_tabulate()
)
names_old <- colnames(normal_repeat)
colnames(normal_repeat) <- paste0(names_old, "_normal")

glaucoma_repeat <- bind_cols(
data_octa_global_intra %>%
  filter(glc_dx_bin == "Glaucoma") %>% 
  get_repeat_table(),
data_octa_global_intra %>%
  filter(glc_dx_bin == "Glaucoma") %>% 
  icc_tabulate()
)
names_old <- colnames(glaucoma_repeat)
colnames(glaucoma_repeat) <- paste0(names_old, "_glc")

bind_cols(
  normal_repeat,
  glaucoma_repeat
) %>% 
  
  # select OCTA vars of interest
  filter(var_name_normal %in% octa_vars_select_labels) %>%

  # remove unimportant variables
  select(
    -var_name_glc, -V1_normal, -V1_glc,
    -starts_with("n_"), -starts_with("N_"),
    -starts_with("k_"), -starts_with("varw_"), -starts_with("vara_")
    ) %>% 
  
  # reorder variables
  select(
  starts_with("var_name_"), starts_with("V1_"), starts_with("n_"), starts_with("N_"),
  starts_with("Âµ_"),
  "ICC_pretty_normal", "ICC_pretty_cl_normal", "ICC_pretty_glc", "ICC_pretty_cl_glc",
  "Sw_pretty_normal", "Sw_pretty_cl_normal", "Sw_pretty_glc", "Sw_pretty_cl_glc",
  "CRw_pretty_normal", "CRw_pretty_cl_normal", "CRw_pretty_glc", "CRw_pretty_cl_glc",
  "CVw_pretty_normal", "CVw_pretty_cl_normal", "CVw_pretty_glc", "CVw_pretty_cl_glc",
  everything()
  ) %>% 
  
  # make html kable
  kable(digits = 3) %>% 
  kable_styling(
    #bootstrap table classes
    bootstrap_options = c( "hover")
  ) %>% 
  # group column headers
  add_header_above(c(" " = 1, "Normal" = 1, "Glaucoma" = 1, "Normal" = 2, "Glaucoma" = 2, "Normal" = 2, "Glaucoma" = 2, "Normal" = 2, "Glaucoma" = 2, "Normal" = 2, "Glaucoma" = 2)) %>% 
  add_header_above(c("OCTA Variable" = 1, "Mean" = 2, "ICC" = 4, "Sw" = 4, "CRw" = 4, "CVw" = 4))
```


#Mixed Effects Regression Models


##Model Fitting

<span style="color:blue">"For the markdown file letâ€™s just spit out all the output from the random effects model and the iccest command so we can show it to Grace. Eventually we can put the ICC in the table with the other repeatability measures you have already tabled but I donâ€™t think we need it for the meeting." - BB 9/4/2019</span>

```{r}
model1.fit <- lmer(v_area_density ~ (1|ptid), data=data_octa_global_intra)
summary(model1.fit)

# model2.fit <- lmer(v_area_density ~ (1|ptid/eyeid), data=data_octa_global_intra)
# summary(model2.fit)
```

<span style="color:blue">"I also added a model to test whether SS influences reliability. The reference level is â€˜10â€™ now, which is what we want, and you can see that SS is highly associated with VAD, meaning it affects reliability." - BB 9/4/2019</span>

```{r}
model3.fit <- lmer(v_area_density ~ signal_strength + (1|ptid), data=data_octa_global_intra)
summary(model3.fit)
```


#References