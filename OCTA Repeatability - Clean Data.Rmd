---
title: "OCTA Reliability â€” Clean Data"
author: "Jae Lee, Bruce Burkemper, Dom Grisafe, Grace Richter"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 1
csl: ophthalmology.csl
bibliography: references.bib
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(readxl)           # import excel files
library(tidyverse)
library(Hmisc)
library(lubridate)
library(ICC)              # inter class correlation
library(labelled)         # add variable labels 
library(kableExtra)       # HTML tables
library(tableone)         # table 1
library(cowplot)          # makes clean plots, with no distractions
theme_set(theme_cowplot())
library(gridExtra)        # allows grid arangement of dissimilar plots together
library(grid)             # add labels to top of grid.arrange plots
library(lme4)
library(lmerTest)
library(citr)
library(details)          # allows hiding r objects in html "details packages"
library(styledom)

# directories
dir_data <- "/Volumes/GoogleDrive/My Drive/2017-2020 USC Roski Eye Institute/OCTA Repeatability - Grace Richter/Data/Jae"
```

##Session Information
```{r}
# prints session info
details::details(object = sessioninfo::session_info(), summary = 'current session info')
```



#Aim

The aim of this study is to obtain the **Reliability** estimates of the OCTA measurements.

Reliability incorporates:

- **Repeatability** - How reliable are repeated measures on the same day (**Intra-Visit**)

- **Reproducibility** - How reliable are repeated measures over multiple visits (**Inter-Visit**)



#Data{.tabset}

This data was taken from a clean dataset that Jae emailed out on January 16th, 2020.

Jae organized the retina by six different methods. He created OCTA variable scores for the overall image, 2 hemifields, 4 quadrants, 6 sectors, 12 clock hours, and an annular ring.  

Annular image scoring was also assessed, and ICC's were similar, but slightly lower than global. Results for annular image scoring are not shown. For now, only the overall "global" image scoring will be shown.

Zeiss commercial **vessel area density** and **flux** variables are also shown for the global image scoring.

```{r}
# functions for formatting stats and confidence intervasls (used at end of analysis)
trim3 <- function(x){sprintf("%.3f", round(as.double(x), 3))}
trim_ci_pretty <- function(lcl, ucl){paste0("(", trim3(lcl), ", ", trim3(ucl), ")")}
```

```{r}
# common factor formats
form_eye    <- function(x){factor(x, levels = c(1:2), labels = c("Left",   "Right"))}
form_ny     <- function(x){factor(x, levels = c(1:2), labels = c("No",    "Yes"))}
form_female <- function(x){factor(x, levels = c(1:2), labels = c("Female", "Male"))}
form_glc     <- function(x){factor(x, levels = c(1:4), labels = c("None", "Mild", "Moderate", "Severe"))}
form_glc_bin <- function(x){factor(x, levels = c(1:2), labels = c("Normal", "Glaucoma"))}
form_glc_bin_people <- function(x){factor(x, levels = c(1:3), labels = c("Normal, Bilateral", "Glaucoma, Bilateral", "Glaucoma, Unilateral"))}
form_dr     <- function(x){factor(x, levels = c(1:5), labels = c("None", "Mild Non-Proliferative Diabetic Retinopathy", "Moderate Non-Proliferative Diabetic Retinopathy", "Severe Non-Proliferative Diabetic Retinopathy", "Proliferative Diabetic Retinopathy"))}
form_surg   <- function(x){factor(x, levels = c(1:4), labels = c("None", "Laser", "Minimally Invasive Glaucoma Surgery", "Filter"))}
form_ss <- function(x){as.integer(x)}

# function that removes extraneous participants
exclude_patients <- function(df){
  df %>% 
    # patient with false eye
    filter(!(ptid %in% c(6919811)))
}
```

```{r}
# function that formats clinical and demographic variables
form_sociodem_vars <- function(df){
  
  # function that puts factors in base-one notation
  base1 <- function(x){as.double(x) + 1}

  df %>% 
    
    # remove unnecessary variables
    select(-Name, -MRN, -`Clinical Findings`, -Comment) %>%

    rename(
      age = Age
    ) %>% 

    # format variables appropriately
    mutate(
      
      ptid = as.character(SID),
      
      female = case_when(
        Sex == "F" ~ 1,
        Sex == "M" ~ 2
      ) %>% form_female(),
      
      htn_dx = base1(HTN) %>% form_ny(),
       dm_dx = base1(DB) %>% form_ny(),
      nro_dx = base1(Neuropathy) %>% form_ny(),
      
      dr_dx_od = base1(`PDR/NPDR_OD`) %>% form_dr(),
      dr_dx_os = base1(`PDR/NPDR_OS`) %>% form_dr(),
      
      glc_sus_dx_od = base1(GS_OD) %>% form_glc(),
      glc_sus_dx_os = base1(GS_OS) %>% form_glc(),
      
      glc_dx_od = base1(GLC_OD) %>% form_glc(),
      glc_dx_os = base1(GLC_OS) %>% form_glc(),

      surg_proc_catextract_od = base1(`Osx(CE)_OD`) %>% form_ny(),
      surg_proc_catextract_os = base1(`Osx(CE)_OS`) %>% form_ny(),
      
      surg_proc_glaucoma_od = base1(`Osx(GLC)_OD`) %>% form_surg(),
      surg_proc_glaucoma_os = base1(`Osx(GLC)_OS`) %>% form_surg()
      
    ) %>% 
    
    # arrange so in appropriate order
    arrange(ptid) %>% 
    
    # remove old variables
    select(-Sex, -HTN, -DB, -Neuropathy,
           -`PDR/NPDR_OD`, -`PDR/NPDR_OS`, -GS_OD, -GS_OS, -GLC_OD, -GLC_OS,
           -`Osx(CE)_OD`, -`Osx(CE)_OS`, -`Osx(GLC)_OD`, -`Osx(GLC)_OS`)

}
```

```{r}

# function that formats OCTA variables
form_vars <- function(df){

  df %>% 
    
    select(NameSIDSexEyeRegion, everything()) %>% 
    
    mutate(
      
      # match first text (upper or lower case) of any length, followed by any underscore, all repeated any number of times
      name = str_extract(string = NameSIDSexEyeRegion, pattern = regex("^[[A-Za-z]*_]+")) %>% str_sub(end = -2),
      
      # matches everything starting with the first number
      SIDSexEyeRegion = str_extract(string = NameSIDSexEyeRegion, pattern = regex("[[0-9]*].*$"))
      
      ) %>% 
    
    # separate the remaining variables
    separate(
      col = SIDSexEyeRegion, sep = "_", remove = TRUE,
      into = c("ptid", "sex", "image_area", "image_method", "image_size", "exam_date", "exam_time", "eye_imaged")
      ) %>% 
    
    # filter blank rows
    filter(!is.na(exam_date)) %>% 
    
    # format variables appropriately
    mutate(
      
    time_stamp = paste(exam_date, exam_time) %>% as.POSIXct(format = "%m%d%Y %H%M%S"),

    exam_date = exam_date %>% as.Date(format = "%m%d%Y"),
    
    eye_imaged = case_when(
      eye_imaged == "OS" ~ 1,
      eye_imaged == "OD" ~ 2
    ) %>% form_eye(),
    
    female = case_when(
      sex == "F" ~ 1,
      sex == "M" ~ 2
    ) %>% form_female(),
    
    image_area = factor(image_area),

    image_method = factor(image_method),
    
    image_size = factor(image_size),
    
    signal_strength = form_ss(SS)
    
    ) %>% 
    
    # remove unnecessary variables
    select(-NameSIDSexEyeRegion, -sex, -exam_time) %>% 
    
    # arrange so in appropriate order
    arrange(ptid, eye_imaged, time_stamp) %>% 
    
    # create a measurement ID
    mutate(eyeid = group_indices(., ptid, eye_imaged)) %>% 
 
    # deidentify names
    select(-name, -SS) %>%
    
    # reorder variables appropriately
    select(ptid, female, eyeid, eye_imaged, image_area, image_size, image_method, exam_date, time_stamp, everything())
  
}
```

**Note to Dom**: The analysis was originally built with the global data. Towards the end of our work, we decided annulus would be a better data to use. I had already built the analysis using global data, so I just "trojan horsed" the annulus excel data into the global analysis that already exists. This is a bit of a hack, but saves an immense amount of time.
```{r, message = FALSE, warning = FALSE}
# create a function that removes the middle initial and titles from the names

# sociodemographic data
data_sociodem <- read_xlsx(paste0(dir_data, "/R&R_PoHX_IOP_MD_all_20200310.xlsx"), sheet = "PoHx") %>% 
  form_sociodem_vars() %>% 
  exclude_patients() %>% 
  # patient with duplicate demographic information (ptid == 6862281)
  #    had birthday between inter-visits, so 2 different age values
  #    use the most recent age, so demographics are for information at baseline
  group_by(ptid) %>% top_n(x = ., n = 1, wt = -age) %>% ungroup()

# OCTA data from group's algorithm
data_octa_filename <- paste0(dir_data, "/RR_all_quantification_02_20_2020.xlsx")
data_octa_global <- read_xlsx(data_octa_filename, sheet = "Annulus") %>% form_vars() %>% exclude_patients()    # THIS IS NOT AN ERROR!!! I INTENTIONALLY "TROJAN HORSED" THE ANNULUS INTO THE GLOBAL TO QUICKLY GET THE ANALYSIS FOR ANNULUS
data_octa_annulus <- read_xlsx(data_octa_filename, sheet = "Annulus") %>% form_vars() %>% exclude_patients()
# data_octa_hemifield <- read_xlsx(data_octa_filename, sheet = "Hemifield") %>% form_vars() %>% exclude_patients()
# data_octa_quadrant <- read_xlsx(data_octa_filename, sheet = "Quadrants") %>% form_vars() %>% exclude_patients()
# data_octa_sector <- read_xlsx(data_octa_filename, sheet = "Sector") %>% form_vars() %>% exclude_patients()
# data_octa_clockhour <- read_xlsx(data_octa_filename, sheet = "Clockhours") %>% form_vars() %>% exclude_patients()

# OCTA data from commercial algorithm
data_octa_commercial <- read_xlsx(data_octa_filename, sheet = "Commercial measurement") %>% form_vars() %>% exclude_patients()
```

```{r}

get_eye_long <- function(df, var){
  
  df %>% 
    select(ptid, age, female, htn_dx, dm_dx, nro_dx, starts_with(var)) %>% 
    pivot_longer(
      cols = starts_with(var),
      names_to = "eye_imaged",
      values_to = var
      ) %>% 
    mutate(
      eye_imaged = case_when(
        grepl(x = eye_imaged, pattern = "_os") ~ 1,
        grepl(x = eye_imaged, pattern = "_od") ~ 2
      ) %>% form_eye()
    )
  
}

# multi-merge sociodemographic variables
data_sociodem_long <- list(
  get_eye_long(data_sociodem, "dr_dx"),
  get_eye_long(data_sociodem, "glc_sus_dx"),
  get_eye_long(data_sociodem, "glc_dx"),
  get_eye_long(data_sociodem, "surg_proc_glaucoma"),
  get_eye_long(data_sociodem, "surg_proc_catextract")
  ) %>% 
  reduce(full_join, by = c("ptid", "eye_imaged", "age", "female", "htn_dx", "dm_dx", "nro_dx")) %>% 
  
  mutate(
    
    # create indicator variable for glaucoma status
    glc_dx_bin = case_when(
      glc_dx %in% c("None") ~ 1,
      glc_dx %in% c("Mild", "Moderate", "Severe") ~ 2
      ) %>% form_glc_bin(),
    
    # create indicator variable for diabetic reinopathy status
    dr_dx_bin = case_when(
      dr_dx == "None" ~ 1,
      dr_dx %in% c(
        "Mild Non-Proliferative Diabetic Retinopathy", 
        "Moderate Non-Proliferative Diabetic Retinopathy", 
        "Severe Non-Proliferative Diabetic Retinopathy",
        "Proliferative Diabetic Retinopathy"
        ) ~ 2
    ) %>% form_ny() 
    
    ) %>% 
  
  # create a variable that indicates whether people are bilateral normal/glaucoma or unilateral glaucoma
  group_by(ptid) %>% mutate(glc_dx_bin_people = mean(as.double(glc_dx_bin), na.rm = T)) %>% ungroup() %>% 
  mutate(glc_dx_bin_people = ifelse(!(glc_dx_bin_people %in% c(1, 2)), 3, glc_dx_bin_people) %>% form_glc_bin_people())
```


```{r}

var_labels <- c(
  ptid = "Patient Identification",
  
  # sociodemographic variables
  age = "Age",
  female = "Sex",
  htn_dx = "Hypertension Diagnosis",
  dm_dx = "Diabetes Mellitus Diagnosis",
  nro_dx = "Optic Neuropathy",
  
  # eye clinical variables
  dr_dx = "Diabetic Retinopathy Diagnosis, Ordinal",
  dr_dx_bin = "Diabetic Retinopathy Diagnosis, Binary",
  glc_sus_dx = "Glaucoma Suspect Diagnosis",
  glc_dx = "Glaucoma Diagnosis, Ordinal",
  glc_dx_bin = "Glaucoma Diagnosis, Binary",
  glc_dx_bin_people = "Glaucoma Diagnosis Laterality, Ordinal",
  surg_proc_glaucoma = "Surgical Procedure for Glaucoma",
  surg_proc_catextract = "Surgical Procedure for Cataract Extraction",
  
  # OCTA Variables
  eyeid = "Eye Identification",
  eye_imaged = "Eye Imaged",
  time_stamp = "Exam Date and Time",
  name_last = "Last Name",
  name_first = "First Name",
  image_area = "Image Area",
  image_method = "Image Method",
  image_size = "Image Size",
  signal_strength = "Signal Strength",
  v_diameter = "Vessel Diameter (units?)",
  v_area_density = "Vessel Area Density",
  v_skeleton_density = "Vessel Skeleton Density (units?)",
  v_perimeter_index = "Vessel Perimeter Index (units?)",
  v_complexity_index = "Vessel Complexity Index (units?)",
  flow_impair_zone = "Flow Impairment Zone (units?)",
  flux = "Flux",
  zeiss_v_area_density = "Vessel Area Density, Zeiss",
  zeiss_flux = "Flux, Zeiss"
)

# assign variable labels
data_dict <-  data.frame(var_labels) %>% 
  rownames_to_column("Variable")
```



##Data Wrangling

###Rename Variables

This section will rename the variables to match the dictionary

```{r}

# commercial data had different variable names than the remaining variables
data_octa_commercial_rename <- data_octa_commercial %>%
  # remove unncessary variables
  select(
    ptid, female, eyeid, eye_imaged, image_area, image_size, image_method, exam_date, time_stamp,
    signal_strength, Area_average, Flux_average
    ) %>% 
  # rename commercial variables
  rename(
    zeiss_v_area_density = Area_average,
    zeiss_flux = Flux_average
  )

# function to rename OCTA variables for internal scoring
rename_octa_vars <- function(df){
  
  df %>% 
    
    # rename variables in existing format
    rename(
      v_diameter = starts_with("Vessel Diameter"),
      v_area_density = starts_with("Vessel Area Density"),
      v_skeleton_density = starts_with("Vessel Skeleton Density"),
      v_perimeter_index = starts_with("Vessel Perimeter Index"),
      v_complexity_index = starts_with("Vessel Complexity Index"),
      flow_impair_zone = starts_with("Flow Impiarment Zone"),
      flux = starts_with("Flux")
    ) 
 
}

data_octa_global_rename <- rename_octa_vars(data_octa_global) %>% 
  # add the commercial global variables to the global dataset
  left_join(
    by = c("ptid", "eyeid", "time_stamp", "signal_strength"), 
    y = data_octa_commercial_rename %>% select(ptid, eyeid, time_stamp, signal_strength, zeiss_v_area_density, zeiss_flux)
    ) %>% 
  # add sociodemographic information
  left_join(y = data_sociodem_long, by = c("ptid", "female", "eye_imaged"))
# data_octa_global_rename %>% glimpse

data_octa_annulus_rename <- rename_octa_vars(data_octa_annulus)
# data_octa_hemifield_rename <- rename_octa_vars(data_octa_hemifield)
# data_octa_quadrant_rename <- rename_octa_vars(data_octa_quadrant)
# data_octa_sector_rename <- rename_octa_vars(data_octa_sector)
# data_octa_clockhour_rename <- rename_octa_vars(data_octa_clockhour)

# check out the renamed datasets
# data_octa_global_rename %>% glimpse
# data_octa_annulus_rename %>% glimpse
```


###Label Variables

This section will label variables appropriately.

```{r}
# match variable labels with variable names in dataframe
label(data_octa_global_rename) <- as.list(var_labels[match(names(data_octa_global_rename), names(var_labels))])
label(data_octa_annulus_rename) <- as.list(var_labels[match(names(data_octa_annulus_rename), names(var_labels))])
# label(data_octa_hemifield_rename) <- as.list(var_labels[match(names(data_octa_hemifield_rename), names(var_labels))])
# label(data_octa_quadrant_rename) <- as.list(var_labels[match(names(data_octa_quadrant_rename), names(var_labels))])
# label(data_octa_sector_rename) <- as.list(var_labels[match(names(data_octa_sector_rename), names(var_labels))])
# label(data_octa_clockhour_rename) <- as.list(var_labels[match(names(data_octa_clockhour_rename), names(var_labels))])
```



##Data Dictionary

```{r}
# print html table
data_dict %>% 
  kable(col.names = c("Variable", "Label")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  pack_rows("Sociodemographic Variables", 2, 3) %>% 
  pack_rows("Systemic Clinical Variables", 4, 6) %>% 
  pack_rows("Ophthalmic Clinical Variables", 7, 12) %>% 
  pack_rows("OCT Angiography Variables", 13, 30) 
```



#Single Eye Participation

Venugopal (2019) et al. ran the analysis including all eyes.[@venugopalRepeatabilityComparabilityPeripapillary2019] Then they re-ran the analysis after selecting only a single eye randomly from each individual. They conclude minimal difference in the findings, and they report only the analysis that includes all eyes: 

"The entire analysis was repeated considering one eye per subject (one eye was randomly chosen from subjects contributing both eyes for the primary analysis) and all the results were similar to the primary analysis."[@venugopalRepeatabilityComparabilityPeripapillary2019]

The following results are for a single eyeâ€”chosen at randomâ€”from each participant. 

Later, towards the bottom of the analysis, the reliability statistics have been repeated for both eyes using linear mixed effects models. 

```{r}
# function that gets just one eye
get_1eye <- function(df){
  
  # set the seed so working with a consistent dataset when randomly sampling left or right eye
  set.seed(123456)
  
  # select random 1 eye per person
  select_1eye <- df %>% 
    # get 1 eyeid
    group_by(ptid, eyeid) %>% sample_n(1) %>% select(ptid, eyeid) %>% ungroup() %>% 
    # sample 1 eye per individual
    group_by(ptid) %>% sample_n(1) %>% ungroup() %>% select(eyeid)
  
  # subset just the eyes in the selection above
  df %>% 
    left_join(x = select_1eye, by = "eyeid")
  
}

# dataset of one eye
data_octa_global_1eye <- data_octa_global_rename %>% get_1eye()

# data set with both eyes
data_octa_global_2eye <- data_octa_global_rename
```



#Subsetting Cohorts

##Intra-Visit Data

Intra-visit data was restricted to all measurements of the same eye that occurred on the same day. Some people had multiple measurements on multiple days. Their first day was included only.

```{r}

# Intra-Visit Data: create a dataset that selects only repeat measurements per day
get_intra <- function(df){

  df %>% 
    
    # create variable that indicates when there is a repeat measurement on the same day for each eye
    add_count(ptid, eye_imaged, exam_date, name = "n_msr_day") %>%
    filter(n_msr_day > 1) %>%
    
    # now that all the days with single measurements have been excluded, pick the first date with multiple measurements
    group_by(ptid, eye_imaged) %>%
    filter(exam_date == min(exam_date)) %>%
    # create an indicator variable that shows the order of measurements
    mutate(order_obs = seq(n())) %>% 
    ungroup() %>% 
    
    # create an indicator variable that shows the order of measurements
    group_by(ptid, eye_imaged) %>% 
    mutate(order_obs = seq(n())) %>% 
    ungroup()    
  
}
 
# create intra dataset for global data 
data_octa_global_intra_1eye <- data_octa_global_1eye %>% get_intra()
data_octa_global_intra_2eye <- data_octa_global_2eye %>% get_intra()
```

##Inter-Visit Data

Inter-visit data was restricted to the first measurement of the day for each eye. If a patient had their right eye measured:    

- 3 times on Monday  

- 5 times on Wednesday, and  

- 2 times on Friday,  

Then they would have three observations in this dataset:

- The first measurement from Monday,  

- The first measurement from Wednesday, and  

- The first measurement from Friday.

```{r}
# Inter-Visit Data: create a dataset that selects the first measurement per day for each eye; there are no repeat measurements per day
get_inter <- function(df, window_days){
  
  df %>% 
    
    # remove people with unilateral glaucoma, only include those with bilateral status
    # dplyr::filter(glc_dx_bin_people %in% c("Normal, Bilateral", "Glaucoma, Bilateral")) %>%
    
    # select the first measurement per day for every eye imaged
    group_by(ptid, eye_imaged, exam_date) %>% 
    top_n(n = -1, wt = time_stamp) %>% 
    ungroup() %>% 
    
    # create an indicator variable that shows the order of measurements
    group_by(ptid, eye_imaged) %>% 
    mutate(order_obs = seq(n())) %>% 
    ungroup() %>% 
    
    # filter only measurements that are within 180 days of each other
    group_by(ptid, eye_imaged) %>% 
    # arrange by increasing exam_date, important for taking the difference in next line
    arrange(exam_date) %>% 
    mutate(
      # set the date of the first visit
      day_one = min(exam_date),
      # take the difference of the exam_date and the first visit
      diff_date = difftime(exam_date, day_one, units = "days"),
      # indicator variable of whether the time since first visit was within n days
      ind_n_day = ifelse(diff_date <= window_days, yes = 1, no = 0)
      ) %>% 
    # remove all observations that were not within the time window
    filter(ind_n_day == 1) %>%
    ungroup() %>% 
    
    # remove all people with just one baseline exam that made it through the filtering
    arrange(ptid) %>% 
    group_by(ptid, eye_imaged) %>% 
    mutate(n_exams = n()) %>% 
    filter(n_exams > 1) %>% 
    ungroup()
  
}

# create inter dataset for global data, infinite day window
data_octa_global_inter_1eye <- data_octa_global_1eye %>% get_inter(window_days = Inf)
data_octa_global_inter_2eye <- data_octa_global_2eye %>% get_inter(window_days = Inf)

# create inter dataset for global data, 365 day window
data_octa_global_inter_1eye365 <- data_octa_global_1eye %>% get_inter(window_days = 365.25)
data_octa_global_inter_2eye365 <- data_octa_global_2eye %>% get_inter(window_days = 365.25)

# create inter dataset for global data, 180 day window
data_octa_global_inter_1eye180 <- data_octa_global_1eye %>% get_inter(window_days = 180)
data_octa_global_inter_2eye180 <- data_octa_global_2eye %>% get_inter(window_days = 180)
```

##Data Flow Chart{.tabset}

This tallies how many participants, how many eyes, and how many measurements are included in the two data sets.

For repeatability statistics, normal and glaucoma groups may sum to greater than the total number of participants in the study because some participants have both eyes normal or both eyes with glaucoma, but some patients have unilateral glaucoma. 

```{r}
# function to filter normal and glaucoma
filter_normal   <- function(df){df %>% dplyr::filter(glc_dx_bin == "Normal")}
filter_glaucoma <- function(df){df %>% dplyr::filter(glc_dx_bin == "Glaucoma")}

# function to get number participants or eyes
count_participants <- function(df){df %>% group_by(ptid) %>% summarise(n()) %>% nrow()}
count_eyes         <- function(df){df %>% group_by(ptid, eye_imaged) %>% summarise(n()) %>% nrow()}

# function that gets a row
get_flow_row <- function(df_label, df){
  data.frame(
    dataset = df_label,
    n_participants = count_participants(df),
    n_eyes = count_eyes(df),
    n_measurements = nrow(df)
  )
}

# function that gets 3 rows: overall, normal, glaucoma
get_flow_chart <- function(label, df){
  bind_rows(
    get_flow_row(label, df),
    get_flow_row(paste0(label, ", Normal"), filter_normal(df)),
    get_flow_row(paste0(label, ", Glaucoma"), filter_glaucoma(df))
  )
}
```

###Both Eyes
```{r, warning=FALSE}
# bind all rows together and make html table
bind_rows(
  get_flow_chart("Intra-Visit", data_octa_global_intra_2eye),
  get_flow_chart("Inter-Visit", data_octa_global_inter_2eye),
  get_flow_chart("Inter-Visit, 1 Year", data_octa_global_inter_2eye365),
  get_flow_chart("Inter-Visit, 6 Months", data_octa_global_inter_2eye180)
  
) %>% 
  kable() %>% 
    kable_styling(bootstrap_options = c("striped", "hover")) %>% 
    pack_rows("Annular Data - Intra-Visit - Both Eyes", 1, 3) %>% 
    pack_rows("Annular Data - Inter-Visit - Both Eyes", 4, 6) %>% 
    pack_rows("Annular Data - Inter-Visit - Both Eyes - Restrict 1 Year", 7, 9) %>%  
    pack_rows("Annular Data - Inter-Visit - Both Eyes - Restrict 6 Months", 10, 12) 
```

###One Eye, Random
```{r, warning=FALSE}
# bind all rows together and make html table
bind_rows(
  get_flow_chart("Intra-Visit", data_octa_global_intra_1eye),
  get_flow_chart("Inter-Visit", data_octa_global_inter_1eye),
  get_flow_chart("Inter-Visit, 1 Year", data_octa_global_inter_1eye365),
  get_flow_chart("Inter-Visit, 6 Months", data_octa_global_inter_1eye180)
  
) %>% 
  kable() %>% 
    kable_styling(bootstrap_options = c("striped", "hover")) %>% 
    pack_rows("Annular Data - Intra-Visit - One Eye, Random", 1, 3) %>% 
    pack_rows("Annular Data - Inter-Visit - One Eye, Random", 4, 6) %>% 
    pack_rows("Annular Data - Inter-Visit - One Eye, Random - Restrict 1 Year", 7, 9) %>%  
    pack_rows("Annular Data - Inter-Visit - One Eye, Random - Restrict 6 Months", 10, 12) 
```

#Missing
```{r, include = FALSE}
data_octa_global_intra_2eye %>% 
  anti_join(data_octa_global_inter_2eye, by = "ptid") %>% 
  kable() %>% 
  kable_styling()
```



#Table 1: Summary Statistics

All table 1 data is shown, but publish only the Table 1 for the Intra-Visit.

For repeatability statistics, normal and glaucoma groups may sum to greater than the total number of participants in the study because some participants have both eyes normal or both eyes with glaucoma, but some patients have unilateral glaucoma. 

```{r}
# function to get table 1 for individual people, no repeated measurements
print_table1_people <- function(df){
 
  vars_systemic <- c("age", "female", "htn_dx", "dm_dx", "nro_dx")
  vars_new <- c("glc_dx_bin", "glc_dx_bin_people", "dr_dx_bin", "surg_proc_catextract", "surg_proc_glaucoma", "signal_strength")
  
  # vars in table 1
  Vars_table1 <- c(vars_systemic, vars_new)

  # dataframe for table 1
  df_table1 <- df %>% 
    
    # format doubles so not categorical
    mutate(
      age = as.double(age),
      ptid = as.double(ptid),
      eyeid = as.double(eyeid),
      glc_dx_bin = as.double(glc_dx_bin),
      glc_dx_bin_people = as.double(glc_dx_bin_people),
      dr_dx_bin = as.double(dr_dx_bin),
      signal_strength = as.double(signal_strength),
      surg_proc_catextract = as.double(surg_proc_catextract),
      surg_proc_glaucoma = as.double(surg_proc_glaucoma)
      ) %>%
    
    # select(ptid, order_obs, age) %>% 
    pivot_wider(
      id_cols = c(ptid, vars_systemic),
      names_prefix = "obs_",
      names_from = c(eye_imaged, order_obs),
      values_from = c(glc_dx_bin, glc_dx_bin_people, dr_dx_bin, signal_strength, surg_proc_glaucoma, surg_proc_catextract)
    ) %>% 
    
    mutate(
      
      signal_strength = rowMeans(select(., starts_with("signal_strength")), na.rm = TRUE) %>% as.double(),
      
      glc_dx_bin = case_when(
        glc_dx_bin_obs_Right_1 == 1 | glc_dx_bin_obs_Right_2 == 1 | glc_dx_bin_obs_Right_3 == 1 |
         glc_dx_bin_obs_Left_1 == 1 |  glc_dx_bin_obs_Left_2 == 1 |  glc_dx_bin_obs_Left_3 == 1 ~ 1,
        glc_dx_bin_obs_Right_1 == 2 | glc_dx_bin_obs_Right_2 == 2 | glc_dx_bin_obs_Right_3 == 2 |
         glc_dx_bin_obs_Left_1 == 2 |  glc_dx_bin_obs_Left_2 == 2 |  glc_dx_bin_obs_Left_3 == 2 ~ 2
      ) %>% form_glc_bin(),
      
      glc_dx_bin_people = case_when(
        glc_dx_bin_people_obs_Right_1 == 1 | glc_dx_bin_people_obs_Right_2 == 1 | glc_dx_bin_people_obs_Right_3 == 1 |
         glc_dx_bin_people_obs_Left_1 == 1 |  glc_dx_bin_people_obs_Left_2 == 1 |  glc_dx_bin_people_obs_Left_3 == 1 ~ 1,
        glc_dx_bin_people_obs_Right_1 == 2 | glc_dx_bin_people_obs_Right_2 == 2 | glc_dx_bin_people_obs_Right_3 == 2 |
         glc_dx_bin_people_obs_Left_1 == 2 |  glc_dx_bin_people_obs_Left_2 == 2 |  glc_dx_bin_people_obs_Left_3 == 2 ~ 2,
        glc_dx_bin_people_obs_Right_1 == 3 | glc_dx_bin_people_obs_Right_2 == 3 | glc_dx_bin_people_obs_Right_3 == 3 |
         glc_dx_bin_people_obs_Left_1 == 3 |  glc_dx_bin_people_obs_Left_2 == 3 |  glc_dx_bin_people_obs_Left_3 == 3 ~ 3      
        ) %>% form_glc_bin_people(),
      
      dr_dx_bin = case_when(
        dr_dx_bin_obs_Right_1 == 1 | dr_dx_bin_obs_Right_2 == 1 | dr_dx_bin_obs_Right_3 == 1 |
         dr_dx_bin_obs_Left_1 == 1 |  dr_dx_bin_obs_Left_2 == 1 |  dr_dx_bin_obs_Left_3 == 1 ~ 1,
        dr_dx_bin_obs_Right_1 == 2 | dr_dx_bin_obs_Right_2 == 2 | dr_dx_bin_obs_Right_3 == 2 |
         dr_dx_bin_obs_Left_1 == 2 |  dr_dx_bin_obs_Left_2 == 2 |  dr_dx_bin_obs_Left_3 == 2 ~ 2
      ) %>% form_ny(),
      
      surg_proc_catextract = case_when(
        surg_proc_catextract_obs_Right_1 == 1 | surg_proc_catextract_obs_Right_2 == 1 | surg_proc_catextract_obs_Right_3 == 1 |
         surg_proc_catextract_obs_Left_1 == 1 |  surg_proc_catextract_obs_Left_2 == 1 |  surg_proc_catextract_obs_Left_3 == 1 ~ 1,
        surg_proc_catextract_obs_Right_1 == 2 | surg_proc_catextract_obs_Right_2 == 2 | surg_proc_catextract_obs_Right_3 == 2 |
         surg_proc_catextract_obs_Left_1 == 2 |  surg_proc_catextract_obs_Left_2 == 2 |  surg_proc_catextract_obs_Left_3 == 2 ~ 2
      ) %>% form_ny(),
      
      # "None", "Laser", "Minimally Invasive Glaucoma Surgery", "Filter"
      surg_proc_glaucoma = case_when(
        surg_proc_glaucoma_obs_Right_1 == 4 | surg_proc_glaucoma_obs_Right_2 == 4 | surg_proc_glaucoma_obs_Right_3 == 4 |
         surg_proc_glaucoma_obs_Left_1 == 4 |  surg_proc_glaucoma_obs_Left_2 == 4 |  surg_proc_glaucoma_obs_Left_3 == 4 ~ 4,
        surg_proc_glaucoma_obs_Right_1 == 3 | surg_proc_glaucoma_obs_Right_2 == 3 | surg_proc_glaucoma_obs_Right_3 == 3 |
         surg_proc_glaucoma_obs_Left_1 == 3 |  surg_proc_glaucoma_obs_Left_2 == 3 |  surg_proc_glaucoma_obs_Left_3 == 3 ~ 3,
        surg_proc_glaucoma_obs_Right_1 == 2 | surg_proc_glaucoma_obs_Right_2 == 2 | surg_proc_glaucoma_obs_Right_3 == 2 |
         surg_proc_glaucoma_obs_Left_1 == 2 |  surg_proc_glaucoma_obs_Left_2 == 2 |  surg_proc_glaucoma_obs_Left_3 == 2 ~ 2,
        surg_proc_glaucoma_obs_Right_1 == 1 | surg_proc_glaucoma_obs_Right_2 == 1 | surg_proc_glaucoma_obs_Right_3 == 1 |
         surg_proc_glaucoma_obs_Left_1 == 1 |  surg_proc_glaucoma_obs_Left_2 == 1 |  surg_proc_glaucoma_obs_Left_3 == 1 ~ 1
      ) %>% form_surg()
      
    ) %>% 
    select(-ends_with("_1"), -ends_with("_2"), -ends_with("_3"))
  
  # add labels from data dictionary
  label(df_table1) <- as.list(var_labels[match(names(df_table1), names(var_labels))])
  
  # format variables for table 1
  df_table1 <- df_table1 %>% 
    mutate(
      age = as.double(age),
      signal_strength = as.double(signal_strength)
    )
  


    ## export table 1 to html
    CreateTableOne(data = df_table1, vars = Vars_table1) %>%
      print(exact = "stage", quote = FALSE, noSpaces = F, printToggle = F, varLabels = T) %>%
      kableone(digits = 3) %>%
      kable_styling(
        #bootstrap table classes
        bootstrap_options = c("striped", "hover")
      ) %>%
      pack_rows("Sociodemographic Variables", 2, 3) %>%
      pack_rows("Systemic Clinical Variables", 4, 6) %>%
      pack_rows("Ophthalmic Clinical Variables", 7, 12) %>%
      pack_rows("Ophthalmic Surgical Variables", 13, 18) %>%
      pack_rows("OCT Angiography Signal Strength", 19, 19)

}

# print_table1_people(data_octa_global_intra_2eye)
```

##Intra-Visit, Both Eyes OCTA Summary Statistics{.tabset}

Variables in intra-visit dataset

###Intra-Visit
```{r, message = FALSE}
data_octa_global_intra_2eye %>% print_table1_people()
```

###Intra-Visit, Normal
```{r, message = FALSE}
data_octa_global_intra_2eye %>% filter_normal() %>% print_table1_people()
```

###Intra-Visit, Glaucoma
```{r, message = FALSE}
data_octa_global_intra_2eye %>% filter_glaucoma() %>% print_table1_people()
```

##Inter-Visit, Both Eyes OCTA Summary Statistics{.tabset}

Variables in inter-visit dataset

###All{.tabset}

####Inter-Visit
```{r, message = FALSE}
data_octa_global_inter_2eye %>% print_table1_people()
```

####Inter-Visit, Normal
```{r, message = FALSE}
data_octa_global_inter_2eye %>% filter_normal() %>% print_table1_people()
```

####Inter-Visit, Glaucoma
```{r, message = FALSE}
data_octa_global_inter_2eye %>% filter_glaucoma() %>% print_table1_people()
```


###1 Year{.tabset}
These are the participants we will be using for **inter-visit glaucoma**

####Inter-Visit
```{r, message = FALSE}
data_octa_global_inter_2eye365 %>% print_table1_people()
```

####Inter-Visit, Normal
```{r, message = FALSE}
data_octa_global_inter_2eye365 %>% filter_normal() %>% print_table1_people()
```

####Inter-Visit, Glaucoma
```{r, message = FALSE}
data_octa_global_inter_2eye365 %>% filter_glaucoma() %>% print_table1_people()
```


###6 Months{.tabset}
These are the participants we will be using for **inter-visit normal**

####Inter-Visit
```{r, message = FALSE}
data_octa_global_inter_2eye180 %>% print_table1_people()
```

####Inter-Visit, Normal
```{r, message = FALSE}
# data_octa_global_inter_2eye180 %>% filter_normal() %>% print_table1_people()
```

####Inter-Visit, Glaucoma
```{r, message = FALSE}
data_octa_global_inter_2eye180 %>% filter_glaucoma() %>% print_table1_people()
```


#Exploratory Data Analysis

## Histograms{.tabset}

### Vessel Area Density
```{r}
plot_hist_continuous(data_octa_global_1eye, var = v_area_density, 0.005)
```

### Vessel Area Density, Zeiss
```{r}
plot_hist_continuous(data_octa_global_1eye, var = zeiss_v_area_density, 0.005) 
```

### Flux
```{r}
plot_hist_continuous(data_octa_global_1eye, var = flux, 0.005)
```

### Flux, Zeiss
```{r}
plot_hist_continuous(data_octa_global_1eye, var = zeiss_flux, 0.005)
```


##Scatter Plots{.tabset}

Scatter plots of OCTA variables by Subject ID for about 10 individuals randomly sampled. These are separated by intra- and inter-visit data sets, and are useful for understanding the data better.

```{r}
scat_octa_sid <- function(octa_var){

  # select a random sample of 10 SID's
  set.seed(1998)
  ptid_sample10 <- data_octa_global_1eye %>% dplyr::filter(eye_imaged == "Right") %>% select(ptid) %>% sample_n(10) %>% unlist() %>% as.character()
  
  get_plot_scatter <- function(df, title, line_color){
    
    df %>%
      dplyr::filter((ptid %in% ptid_sample10) & (eye_imaged == "Right")) %>%
      ggplot(aes_string(x = "ptid", y = octa_var, group = "ptid")) +
      geom_point(alpha = 0.1, size = 5, color = line_color) +
      ylim(min(data_octa_global_1eye[[octa_var]]), max(data_octa_global_1eye[[octa_var]])) +
      ggtitle(title) +
      ylab("") +
      xlab("") +
      theme(
      legend.position = "none",
      plot.title = element_text(hjust = 0.5),
      axis.text.x = element_text(angle = 30, hjust = 1, size = 7)
      )
    
  }

grid.arrange(ncol = 2, left = var_labels[octa_var], top = "OCTA Measures by Patient", bottom = var_labels["ptid"],

  get_plot_scatter(df = data_octa_global_intra_1eye, title = "Intra", line_color = "red"),
  get_plot_scatter(df = data_octa_global_inter_1eye, title = "Inter", line_color = "blue")

)
}

# scat_octa_sid("v_area_density")
```

###Vessel Area Density
```{r}
scat_octa_sid("v_area_density")
```

###Vessel Area Density, Zeiss
```{r}
scat_octa_sid("zeiss_v_area_density")
```

###Vessel Diameter
```{r}
scat_octa_sid("v_diameter")
```

###Vessel Skeleton Density
```{r}
scat_octa_sid("v_skeleton_density")
```

###Vessel Perimeter Index
```{r}
scat_octa_sid("v_perimeter_index")
```

###Vessel Complexity Index
```{r}
scat_octa_sid("v_complexity_index")
```

###Flow Impairment Zone
```{r}
scat_octa_sid("flow_impair_zone")
```

###Flux
```{r}
scat_octa_sid("flux")
```

###Flux, Zeiss
```{r}
scat_octa_sid("zeiss_flux")
```

##Spaghetti Plots{.tabset}

Spaghetti plots of OCTA variables for about 10 individuals randomly sampled.

```{r}

spaghet_plot <- function(octa_var){

  # select a random sample of 10 patients
  set.seed(2448)
  ptid_sample10 <- data_octa_global_1eye %>% dplyr::filter(eye_imaged == "Right") %>% select(ptid) %>% sample_n(10) %>% unlist() %>% as.character()
  
  # function that creates the plot
  get_plot_spaghet <- function(df, title, line_color){
    df %>%
      dplyr::filter((ptid %in% ptid_sample10) & (eye_imaged == "Right")) %>%
      ggplot(aes_string(x = "time_stamp", y = octa_var, group = "ptid")) +
      geom_line(alpha = 0.5, size = 1, color = line_color) +
      theme(legend.position = "none") +
      ylim(min(data_octa_global_1eye[[octa_var]]), max(data_octa_global_1eye[[octa_var]])) +
      ggtitle(title) +
      ylab("") +
      xlab("") +
      theme(
        legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 30, hjust = 1, size = 7)
      )
  }

grid.arrange(ncol = 2, left = var_labels[octa_var], top = "OCTA Measures Over Time", bottom = var_labels["time_stamp"],

  get_plot_spaghet(df = data_octa_global_intra_1eye, title = "Intra", line_color = "red"),
  get_plot_spaghet(df = data_octa_global_inter_1eye, title = "Inter", line_color = "blue")

)
  
}

# spaghet_plot("v_area_density")
```

###Vessel Area Density
```{r}
spaghet_plot("v_area_density")
```

###Vessel Area Density, Zeiss
```{r}
spaghet_plot("zeiss_v_area_density")
```

###Vessel Diameter
```{r}
spaghet_plot("v_diameter")
```

###Vessel Skeleton Density
```{r}
spaghet_plot("v_skeleton_density")
```

###Vessel Perimeter Index
```{r}
spaghet_plot("v_perimeter_index")
```

###Vessel Complexity Index
```{r}
spaghet_plot("v_complexity_index")
```

###Flow Impairment Zone
```{r}
spaghet_plot("flow_impair_zone")
```

###Flux
```{r}
spaghet_plot("flux")
```

###Flux, Zeiss
```{r}
spaghet_plot("zeiss_flux")
```



#Bland-Altman Plots

Coding of Bland-Altman (BA) plots is explained in this [blog post](https://www.r-bloggers.com/bland-altmantukey-mean-difference-plots-using-ggplot2/).


##Intra-Visit Bland-Altman Plots{.tabset}

Intra-Visit Bland-Altman Plots of OCTA Variables


```{r, warning = FALSE}

# # function that gets repeatability statistics
# get_blandaltman <- function(df, octa_var){
# 
#   # make OCTA variable name
#   octa_name_df <- df %>% mutate(label = label(!!octa_var))
#   octa_name <- octa_name_df[1, "label"] %>% as.character()
#   
#   # intra-visit dataset
#   data_blandalt <- df %>%
# 
#     # select only the measurement ID and the OCTA variable of interest
#     select(ptid, eye_imaged, order_obs, eyeid, !!octa_var) %>%
#         
#     # only select the first 2 measurements
#     filter(order_obs <= 2) %>% 
# 
#     group_by(ptid, eye_imaged) %>% 
# 
#     # calculate the difference and mean of measurements for each individual eye
#     mutate(
#       diff = diff(!!octa_var),
#       mean = mean(!!octa_var)
#       ) %>% ungroup() %>% 
#     select(!!octa_var, everything())
# 
#   p_blandalt <- data_blandalt %>%
#     ggplot(aes(x = mean, y = diff)) +
#     scale_y_continuous(limits = c(-max(data_blandalt$diff)*1.5, max(data_blandalt$diff)*1.5)) +
#     geom_point(size = 0.6, alpha = 0.9) +
#     geom_hline(yintercept = mean(data_blandalt$diff), colour = "blue", size = 0.5, linetype = 2) +
#     geom_hline(yintercept = mean(data_blandalt$diff) - (1.96 * sd(data_blandalt$diff)), colour = "red", size = 0.5, linetype = 2) +
#     geom_hline(yintercept = mean(data_blandalt$diff) + (1.96 * sd(data_blandalt$diff)), colour = "red", size = 0.5, linetype = 2) +
#     geom_text(aes(label = ifelse(
#       diff >  mean(data_blandalt$diff) + (1.96 * sd(data_blandalt$diff)) |
#       diff <  mean(data_blandalt$diff) - (1.96 * sd(data_blandalt$diff)),
#         yes = as.character(eyeid), no = ''
#       )), hjust = 0, vjust = 0, color = "darkgray", size = 3) +
#     ggtitle("") +
#     ylab("Difference in Measurements") +
#     xlab("Average Measurements")
# 
#   p_diffdist <- data_blandalt %>%
#     ggplot(aes(x = diff)) +
#     geom_vline(xintercept = mean(data_blandalt$diff), colour = "blue", size = 0.5, linetype = 2) +
#     geom_vline(xintercept = mean(data_blandalt$diff) - (1.96 * sd(data_blandalt$diff)), colour = "red", size = 0.5, linetype = 2) +
#     geom_vline(xintercept = mean(data_blandalt$diff) + (1.96 * sd(data_blandalt$diff)), colour = "red", size = 0.5, linetype = 2) +
#     geom_histogram(bins = 30, alpha = 0.9) +
#     geom_text(aes(label = ifelse(
#       diff >  mean(data_blandalt$diff) + (1.96 * sd(data_blandalt$diff)) |
#       diff <  mean(data_blandalt$diff) - (1.96 * sd(data_blandalt$diff)),
#         yes = as.character(eyeid), no = ''
#       ), y = 6), hjust = 0, vjust = 0, color = "darkgray", size = 3) +
#     scale_y_continuous(limits = c(0, 200), breaks = seq(0,200,50)) +
#     scale_x_continuous(limits = c(-max(data_blandalt$diff)*1.5, max(data_blandalt$diff)*1.5)) +
#     ggtitle("") +
#     xlab("Difference in Measurements")
# 
#   grid.arrange(ncol = 2, top = octa_name, p_blandalt, p_diffdist)
# }
# get_blandaltman(df = data_octa_global_intra_1eye, octa_var = quo(v_area_density))
```

```{r, warning = FALSE}

# function that gets repeatability statistics
get_blandaltman_data <- function(df, octa_var){

  # intra-visit dataset
  df %>%

    # select only the measurement ID and the OCTA variable of interest
    select(ptid, eye_imaged, order_obs, eyeid, !!octa_var, glc_dx_bin) %>%
        
    # only select the first 2 measurements
    filter(order_obs <= 2) %>% 

    group_by(ptid, eye_imaged) %>% 

    # calculate the difference and mean of measurements for each individual eye
    mutate(
      diff = diff(!!octa_var),
      mean = mean(!!octa_var)
      ) %>% ungroup() %>% 
    select(!!octa_var, everything())

}

get_blandaltman_plot <- function(df){
  
  data_blandalt <- df
  
  df %>%
    ggplot(aes(x = mean, y = diff)) +
    scale_y_continuous(limits = c(-max(data_blandalt$diff)*1.5, max(data_blandalt$diff)*1.5)) +
    geom_point(size = 0.1, alpha = 1) +
    geom_hline(yintercept = mean(data_blandalt$diff), colour = "blue", size = 0.5, linetype = 2) +
    geom_hline(yintercept = mean(data_blandalt$diff) - (1.96 * sd(data_blandalt$diff)), colour = "red", size = 0.5, linetype = 2) +
    geom_hline(yintercept = mean(data_blandalt$diff) + (1.96 * sd(data_blandalt$diff)), colour = "red", size = 0.5, linetype = 2) 
    # this adds the labels to the data points that are over the 95% CI's...comment out if not interested
    # geom_text(aes(label = ifelse(
    #   diff >  mean(data_blandalt$diff) + (1.96 * sd(data_blandalt$diff)) |
    #   diff <  mean(data_blandalt$diff) - (1.96 * sd(data_blandalt$diff)),
    #     yes = as.character(eyeid), no = ''
    #   )), hjust = 0, vjust = 0, color = "darkgray", size = 3) 

}

get_blandaltman_hist <- function(df){
  
  data_blandalt <- df
  
  df %>%
    ggplot(aes(x = diff)) +
    geom_vline(xintercept = mean(data_blandalt$diff), colour = "blue", size = 0.5, linetype = 2) +
    geom_vline(xintercept = mean(data_blandalt$diff) - (1.96 * sd(data_blandalt$diff)), colour = "red", size = 0.5, linetype = 2) +
    geom_vline(xintercept = mean(data_blandalt$diff) + (1.96 * sd(data_blandalt$diff)), colour = "red", size = 0.5, linetype = 2) +
    geom_histogram(bins = 30, alpha = 0.9) +
    scale_y_continuous(limits = c(0, 200), breaks = seq(0,200,50)) +
    scale_x_continuous(limits = c(-max(data_blandalt$diff)*1.5, max(data_blandalt$diff)*1.5)) +
    ggtitle("") +
    xlab("Difference in Measurements")
  
}

get_blandaltman <- function(df, octa_var){
  
  # make OCTA variable name
  octa_name_df <- df %>% mutate(label = label(!!octa_var))
  octa_name <- octa_name_df[1, "label"] %>% as.character()
  
  p_data <- get_blandaltman_data(df, octa_var)
  
  p1 <- get_blandaltman_plot(p_data) +
    ggtitle("") +
    ylab("Difference in Measurements") +
    xlab("Average Measurements")
  
  p2 <- get_blandaltman_hist(p_data)
    
  grid.arrange(ncol = 2, top = octa_name, p1, p2)
  
}

# both plots
get_blandaltman(df = data_octa_global_intra_1eye, octa_var = quo(v_area_density))

# just one plot
# get_blandaltman_data(data_octa_global_intra_2eye, quo(v_area_density)) %>% get_blandaltman_plot()
```


###Vessel Area Density
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_intra_1eye, octa_var = quo(v_area_density))
```

###Vessel Area Density, Zeiss
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_intra_1eye, octa_var = quo(zeiss_v_area_density))
```

###Vessel Diameter
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_intra_1eye, octa_var = quo(v_diameter))
```

###Vessel Skeleton Density
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_intra_1eye, octa_var = quo(v_skeleton_density))
```

###Vessel Perimeter Index
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_intra_1eye, octa_var = quo(v_perimeter_index))
```

###Vessel Complexity Index
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_intra_1eye, octa_var = quo(v_complexity_index))
```

###Flow Impairment Zone
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_intra_1eye, octa_var = quo(flow_impair_zone))
```

###Flux
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_intra_1eye, octa_var = quo(flux))
```

###Flux, Zeiss
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_intra_1eye, octa_var = quo(zeiss_flux))
```

###Outliers

Assess some of the observations outside of expected limits.

```{r}
potential_outliers <- c(92, 95, 39, 220, 192, 183, 171, 40, 232, 21, 58, 143, 40, 183, 18, 208, 192, 21, 130, 174, 11, 171, 192, 183, 92, 95)

data_octa_global_intra_1eye %>% 
  filter(eyeid %in% potential_outliers) %>% 
  select(eyeid,	ptid, signal_strength, everything()) %>% 
  kable(digits = 3) %>%
  kable_styling(
    #bootstrap table classes
    bootstrap_options = c( "hover")
  )
```


##Inter-Visit Bland-Altman Plots{.tabset}

Inter-Visit Bland-Altman Plots of OCTA Variables

###Vessel Area Density
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_inter_1eye, octa_var = quo(v_area_density))
```

###Vessel Area Density, Zeiss
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_inter_1eye, octa_var = quo(zeiss_v_area_density))
```

###Vessel Diameter
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_inter_1eye, octa_var = quo(v_diameter))
```

###Vessel Skeleton Density
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_inter_1eye, octa_var = quo(v_skeleton_density))
```

###Vessel Perimeter Index
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_inter_1eye, octa_var = quo(v_perimeter_index))
```

###Vessel Complexity Index
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_inter_1eye, octa_var = quo(v_complexity_index))
```

###Flow Impairment Zone
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_inter_1eye, octa_var = quo(flow_impair_zone))
```

###Flux
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_inter_1eye, octa_var = quo(flux))
```

###Flux, Zeiss
```{r, warning = FALSE}
get_blandaltman(df = data_octa_global_inter_1eye, octa_var = quo(zeiss_flux))
```


###Outliers

Assess some of the observations outside of expected limits.

```{r}
data_octa_global_inter_1eye %>% 
  filter(eyeid %in% c(42, 75, 82, 92, 220, 232, 244)) %>% 
  select(eyeid,	ptid, signal_strength, everything()) %>% 
  kable(digits = 3) %>%
  kable_styling(
    #bootstrap table classes
    bootstrap_options = c( "hover")
  )
```



#Reliability, One Eye

Reliability of OCTA Variables

Calculate the within-subject standard deviation $(S_w)$, the within-subject coefficient of repeatability $(CR_w)$, and the within-subject coefficient of variation $(CV_w)$ for a given measurement variable $x$.  

```{r, include = FALSE}

# I tried to calculate the Sw manually and by using the one-way anova table, as instructed in Bland (1996). However, the two methods are producing different answers for Sw. Therefore, try to use the data in the paper to recalculate Sw for the sample data provided.

# after rechecking, it turns out my calculations were correct, but it's just the rounding errors combined with squaring and square-rooting to go from standard deviation to variance that caused the differences.

# data copied from Bland (1996)
df_bland96 <- matrix(c(190, 220, 200, 200, 202.50, 12.58, 220, 200, 240, 230, 222.50, 17.08, 260, 260, 240, 280, 260.00, 16.33, 210, 300, 280, 265, 263.75, 38.60, 270, 265, 280, 270, 271.25, 6.29, 280, 280, 270, 275, 276.25, 4.79, 260, 280, 280, 300, 280.00, 16.33, 275, 275, 275, 305, 282.50, 15.00, 280, 290, 300, 290, 290.00, 8.16, 320, 290, 300, 290, 300.00, 14.14, 300, 300, 310, 300, 302.50, 5.00, 270, 250, 330, 370, 305.00, 55.08, 320, 330, 330, 330, 327.50, 5.00, 335, 320, 335, 375, 341.25, 23.58, 350, 320, 340, 365, 343.75, 18.87, 360, 320, 350, 345, 343.75, 17.02, 330, 340, 380, 390, 360.00, 29.44, 335, 385, 360, 370, 362.50, 21.02, 400, 420, 425, 420, 416.25, 11.09, 430, 460, 480, 470, 460.00, 21.60), ncol = 6, byrow = T, dimnames = list(c(), c("1st", "2nd", "3rd", "4th", "Mean", "SD"))) %>%
  # convert to dataframe
  as.data.frame() %>%
  # make a column of children ID
  mutate(children = seq(1:20)) %>% select(children, everything())

# calculate the values manually
df_bland96 %>%
  # take the average of mean measurements and the average of the variances
  summarise(
    Xw = mean(Mean),
    Sw = sqrt(mean(SD^2))
    ) %>%
  # square root the variances
  mutate(
    CRw = sqrt(2)*1.96*Sw,
    CVw = 100*Sw/Xw
    )

df_bland96 %>%
  select(children, `1st`, `2nd`, `3rd`, `4th`) %>% mutate(children = factor(children)) %>%
  gather(key = measurement, value = value, -children) %>%
  # select only the eye ID, the eye ID, and the OCTA variable of interest
  aov(formula = value ~ children)
```

##Table 2: Reliability

Table 2 shows Reliability estimates of vessel density measurements.

<span style="color:blue">This table was modeled after Table 2 in Venugopal (2018).[@venugopalRepeatabilityVesselDensity2018]</span> 

```{r}
# function that gets Reliability statistics
get_reliability <- function(df, octa_var){

trim3 <- function(x){sprintf("%.3f", round(x, 3))}

  # make OCTA variable name
  octa_name <- var_labels[as_label(octa_var)]
  
  # intra-visit dataset
  df %>%

    # select only the measurement ID and the OCTA variable of interest
    select(ptid, eyeid, eye_imaged, order_obs, !!octa_var) %>%

    # group by measurement ID
    group_by(eyeid) %>%

    # calculate the mean and variance of measurements for each individual
    mutate(
      mean = base::mean(!!octa_var),
      var = stats::sd(!!octa_var)^2
      ) %>%

    # remove grouping by measurement ID
    ungroup() %>%

    # take the average of mean measurements and the average of the variances
    summarise(
      n = n(),
      Âµ = mean(mean),
      Sw = sqrt(mean(var)),
      se_var = sd(var)/sqrt(n()),
      sw_95l = Sw - 1.96*se_var,
      sw_95u = Sw + 1.96*se_var
      ) %>%

    # square root the variances
    mutate(
      
      CRw = sqrt(2)*1.96*Sw,
      CRw_95l = sqrt(2)*1.96*sw_95l,
      CRw_95u = sqrt(2)*1.96*sw_95u,
      
      CVw = 100*Sw/Âµ,
      CVw_95l = 100*sw_95l/Âµ,
      CVw_95u = 100*sw_95u/Âµ,

      var_name = octa_name
      
      ) %>%
    
    # make the variables pretty\
    
    mutate(
      Sw_pretty = trim3(Sw),
      Sw_pretty_cl = paste0("(", trim3(sw_95l), ", ", trim3(sw_95u), ")"),
      CRw_pretty = trim3(CRw),
      CRw_pretty_cl = paste0("(", trim3(CRw_95l), ", ", trim3(CRw_95u), ")"),
      CVw_pretty = trim3(CVw),
      CVw_pretty_cl = paste0("(", trim3(CVw_95l), ", ", trim3(CVw_95u), ")")
    ) %>% 
    
    # remove ugly variables
    select(
      -Sw, -se_var, -sw_95l, -sw_95u,
      -CRw, -CRw_95l, -CRw_95u,
      -CVw, -CVw_95l, -CVw_95u
      ) %>% 
    
    select(var_name, everything())

}

get_repeat_table <- function(df_table){
  
  # call reliability statistics on each measurement, then make into a table
  get_reliability(df = df_table, octa_var = quo(v_diameter)) %>%
    rbind(
      get_reliability(df = df_table, octa_var = quo(v_area_density)),
      get_reliability(df = df_table, octa_var = quo(zeiss_v_area_density)),
      get_reliability(df = df_table, octa_var = quo(v_skeleton_density)),
      get_reliability(df = df_table, octa_var = quo(v_perimeter_index)),
      get_reliability(df = df_table, octa_var = quo(v_complexity_index)),
      get_reliability(df = df_table, octa_var = quo(flow_impair_zone)),
      get_reliability(df = df_table, octa_var = quo(flux)),
      get_reliability(df = df_table, octa_var = quo(zeiss_flux))
    ) 

}

get_repeat_kable <- function(df_kable){
  
  df_kable %>% 
    
    # make html "kable" and round digits
    kable(digits = 3, col.names = c("OCTA Variable", "n_measure", "Âµ", "Sw", "Sw 95% CL", "CRw", "CRw 95% CL", "CVw", "CVw 95% CL")) %>%
    kable_styling(
      #bootstrap table classes
      bootstrap_options = c( "hover")
    )
}
```

###Intra-Visit Repeatability{.tabset}

####Normal
```{r}
data_octa_global_intra_1eye %>%
  filter(glc_dx_bin == "Normal") %>% 
  get_repeat_table() %>% 
  get_repeat_kable()
```

####Glaucoma
```{r}
data_octa_global_intra_1eye %>%
  filter(glc_dx_bin == "Glaucoma") %>% 
  get_repeat_table() %>% 
  get_repeat_kable()
```


###Inter-Visit Reproducibility

Restrict to repeat measurements within a given window of time to minimize differences due to real changes in psychopathology.

####Inter-Visit Reproducibility Normal{.tabset}

#####Normal, All
```{r}
data_octa_global_inter_1eye %>%
  filter(glc_dx_bin == "Normal") %>% 
  get_repeat_table() %>% 
  get_repeat_kable()
```

#####Normal, 365 Days
```{r}
data_octa_global_inter_1eye365 %>% 
  filter(glc_dx_bin == "Normal") %>% 
  get_repeat_table() %>% 
  get_repeat_kable()
```

#####Normal, 180 Days
```{r}
data_octa_global_inter_1eye180 %>% 
  filter(glc_dx_bin == "Normal") %>% 
  get_repeat_table() %>% 
  get_repeat_kable()
```


####Inter-Visit Reproducibility Glaucoma{.tabset}

#####Glaucoma, All
```{r}
data_octa_global_inter_1eye %>%
  filter(glc_dx_bin == "Glaucoma") %>% 
  get_repeat_table() %>% 
  get_repeat_kable()
```

#####Glaucoma, 365 Days
```{r}
data_octa_global_inter_1eye365 %>%
  filter(glc_dx_bin == "Glaucoma") %>% 
  get_repeat_table() %>% 
  get_repeat_kable()
```

#####Glaucoma, 180 Days
```{r}
data_octa_global_inter_1eye180 %>%
  filter(glc_dx_bin == "Glaucoma") %>% 
  get_repeat_table() %>% 
  get_repeat_kable()
```

##Calculating Reliability Statistics

Explanations of reliability statistic calculations  

###Within-Subject Mean $(\mu_w)$

$\mu_w$ is the average of all measurements of one eye for a given individual. The overall mean $(\mu)$ is calculated by taking the mean of $\mu_w$ across the dataset. The overall mean is included in the final table for reference.

\[ \mu_w = \frac{1}{M}\sum_{i=1}^{M} x_i  \]

\[\text{where } M \text{ is the number of measurements per eye,}\]

###Within-Subject Standard Deviation $(S_w)$

Find $S_w$ by first calculating the variance of the measurements per individual eye. The equation below is general for any number of measurements; in this study there are at least 2 measurements per eye, but sometimes more.  

\[ \sigma^2_{measurement} =  \frac{1}{M}\sum_{i=1}^{M} (x_i - \mu_w)^2 \]

\[ \text{where } M \text{ is the number of measurements per eye}  \]

To calculate $S_w$, average of the variance of measurements $(\sigma^2_{measurement})$ for all eyes measured, then take the square root.  

\[ Sw =  \sqrt{\frac{1}{N}\sum_{i=1}^{N}\sigma^2_{measurement,i}} \]

\[ \text{where } N \text{ is the number of eyes measured} \]

###Within-Subject Coefficient of Repeatability $(CR_w)$

The $CR_w$ provides the uncertainty of repeated measures.

\[ CRw = \sqrt2 * 1.96 * Sw \]

The $CR_w$ can be interpreted as:  

"The difference between two measurements for the same subject is expected to be less than [$CR_w$] for 95% of pairs of observations."[@blandStatisticsNotesMeasurement1996]

###Within-Subject Coefficient of Variation $(CV_w)$

\[ CVw = 100 *\frac{Sw}{\mu} \]



#ICC, One Eye

Intraclass Correlation Coefficient (ICC) is scored using the **ICCest()** function from the **ICC** package. This function "estimates the ICC and confidence intervals using the variance components from a one-way ANOVA."

ICCest() adjusts for repeat measurements on each participant, but not for repeat measurements on both eyes. Therefore, ICC calculations with this function will be done for data from 1 eye per participant.

This is a preliminary result, as we want to calculate the ICC after adjusting for participant and eye (left or right). This will be done later in the mixed effects regression models.

```{r}
# function that produces a kable output for internal datasets
icc_tabulate <- function(df){

  library(ICC)

  # function that calls ICC function, adds a column to front with variable name
  icc_that <- function(df, var){
      c(var, ICCest(factor(eyeid), var, data = df))
  }

  # call the ICC function on each OCTA variable, then r bind into a table
  rbind(
    icc_that(df, "v_diameter"),
    icc_that(df, "v_area_density"),
    icc_that(df, "zeiss_v_area_density"),
    icc_that(df, "v_skeleton_density"),
    icc_that(df, "v_perimeter_index"),
    icc_that(df, "v_complexity_index"),
    icc_that(df, "flow_impair_zone"),
    icc_that(df, "flux"),
    icc_that(df, "zeiss_flux")
  ) %>% as.data.frame() %>%
    # round columns
    mutate(
      V1 = var_labels[as.character(V1)],
      ICC = as.double(ICC),
      k = as.double(k),
      varw = as.double(varw),
      vara = as.double(vara),
      
      ICC_pretty = trim3(ICC),
      ICC_pretty_cl = trim_ci_pretty(LowerCI, UpperCI)
      ) %>% 
    
    # remove unweildy variables
    select(-ICC, -LowerCI, -UpperCI) %>% 
    # order desirably
    select(V1, N, ICC_pretty, ICC_pretty_cl, everything())

}

icc_tabulate_kable <- function(df_kable){
  
  df_kable %>% 
    # call kable
    kable(digit = 3, col.names = c("OCTA Variable", "n_people", "ICC", "ICC 95% CL", "k", "varw", "vara")) %>%
    #bootstrap table classes
    kable_styling(bootstrap_options = c("striped", "hover"))
  
}
```


##Intra-Visit ICC, One Eye{.tabset}

###Normal
```{r, warning=FALSE}
data_octa_global_intra_1eye %>%
  filter(glc_dx_bin == "Normal") %>% 
  icc_tabulate() %>% 
  icc_tabulate_kable
```

###Glaucoma
```{r, warning=FALSE}
data_octa_global_intra_1eye %>%
  filter(glc_dx_bin == "Glaucoma") %>% 
  icc_tabulate() %>% 
  icc_tabulate_kable
```


##Inter-Visit ICC, One Eye

###Inter-Visit ICC Normal{.tabset}

####Normal, All
```{r, warning=FALSE}
data_octa_global_inter_1eye %>%
  filter(glc_dx_bin == "Normal") %>% 
  icc_tabulate() %>% 
  icc_tabulate_kable
```

####Normal, 365 Days
```{r, warning=FALSE}
data_octa_global_inter_1eye365 %>%
  filter(glc_dx_bin == "Normal") %>% 
  icc_tabulate() %>% 
  icc_tabulate_kable
```

####Normal, 180 Days
```{r, warning=FALSE}
data_octa_global_inter_1eye180 %>%
  filter(glc_dx_bin == "Normal") %>% 
  icc_tabulate() %>% 
  icc_tabulate_kable
```

###Inter-Visit ICC Glaucoma{.tabset}

####Glaucoma
```{r, warning=FALSE}
data_octa_global_inter_1eye %>%
  filter(glc_dx_bin == "Glaucoma") %>% 
  icc_tabulate() %>% 
  icc_tabulate_kable
```

####Glaucoma, 365 Days
```{r, warning=FALSE}
data_octa_global_inter_1eye365 %>%
  filter(glc_dx_bin == "Glaucoma") %>% 
  icc_tabulate() %>% 
  icc_tabulate_kable
```

####Glaucoma, 180 Days
```{r, warning=FALSE}
data_octa_global_inter_1eye180 %>%
  filter(glc_dx_bin == "Glaucoma") %>% 
  icc_tabulate() %>% 
  icc_tabulate_kable
```


##Calculating ICC Statistic

\[ \text{ICC} = \frac{\text{between}}{\text{between} + \text{within}}\]

<span style="color:blue">"In the output for the random effects model â€˜SIDâ€™ is the estimated between-group variance, which in the ICCest output is called â€˜varaâ€™ (variance among groups). The within-group variance is â€˜Residualâ€™ in the random effects model output, while in ICCest itâ€™s called â€˜varw.â€™ You can see that the values for those two variances match perfectly in the two different outputs. The ICC is defined as between/(between+within). That calculation is not part of the random effects model output, but it is part of the ICCest output, along with confidence intervals for the ICC estimate. The ICC are really high for intravisit (around 97%) and a little lower for intervisit (about 94%). If we were to calculate these ICC for glaucoma and controls separately I think they would be significantly lower because of the reduced between-group variability." - BB 9/4/2019</span> 



#ARVO Abstract Tables, One Eye

**Do not use these tables for the final write-up.**

Originally, we submitted the abstract to ARVO after calculating reliability statistics on one, randomly selected eye per person. These are kept in the analysis here just to show what we had previously shown. Now, we have calculated these statistics using both eyes (down below). So when writing the final paper, only include those.

##Table 1: Participants

```{r}
print_table1_people(data_octa_global_intra_1eye)
```

##Table 2: Reliability Statistics, One Eye
```{r}
# choose the variables of interest in the tables
octa_vars_select_vars <- c("v_area_density", "zeiss_v_area_density", "v_skeleton_density", "flux", "zeiss_flux")
octa_vars_select_labels <- var_labels[octa_vars_select_vars]

get_big_stats_table <- function(df_normal, df_glaucoma){
  normal_repeat <- bind_cols(
  df_normal %>%
    filter(glc_dx_bin == "Normal") %>% 
    get_repeat_table(),
  df_normal %>%
    filter(glc_dx_bin == "Normal") %>% 
    icc_tabulate()
  )
  names_old <- colnames(normal_repeat)
  colnames(normal_repeat) <- paste0(names_old, "_normal")

  glaucoma_repeat <- bind_cols(
  df_glaucoma %>%
    filter(glc_dx_bin == "Glaucoma") %>%
    get_repeat_table(),
  df_glaucoma %>%
    filter(glc_dx_bin == "Glaucoma") %>%
    icc_tabulate()
  )
  names_old <- colnames(glaucoma_repeat)
  colnames(glaucoma_repeat) <- paste0(names_old, "_glc")

  bind_cols(
    normal_repeat,
    glaucoma_repeat
  ) %>%

    # select OCTA vars of interest
    filter(var_name_normal %in% octa_vars_select_labels) %>%

    # remove unimportant variables
    select(
      -var_name_glc, -V1_normal, -V1_glc,
      -starts_with("n_"), -starts_with("N_"),
      -starts_with("k_"), -starts_with("varw_"), -starts_with("vara_")
      ) %>%

    # reorder variables
    select(
    starts_with("var_name_"), starts_with("V1_"), starts_with("n_"), starts_with("N_"),
    starts_with("Âµ_"),
    "ICC_pretty_normal", "ICC_pretty_cl_normal", "ICC_pretty_glc", "ICC_pretty_cl_glc",
    "Sw_pretty_normal", "Sw_pretty_cl_normal", "Sw_pretty_glc", "Sw_pretty_cl_glc",
    "CRw_pretty_normal", "CRw_pretty_cl_normal", "CRw_pretty_glc", "CRw_pretty_cl_glc",
    "CVw_pretty_normal", "CVw_pretty_cl_normal", "CVw_pretty_glc", "CVw_pretty_cl_glc",
    everything()
    ) %>% 
    
    # make html kable
    kable(digits = 3, format = "html") %>% 
    kable_styling(
      #bootstrap table classes
      bootstrap_options = c( "hover")
    ) %>% 
    # group column headers
    add_header_above(c(" " = 1, "Normal" = 1, "Glaucoma" = 1, "Normal" = 2, "Glaucoma" = 2, "Normal" = 2, "Glaucoma" = 2, "Normal" = 2, "Glaucoma" = 2, "Normal" = 2, "Glaucoma" = 2)) %>% 
    add_header_above(c("OCTA Variable" = 1, "Mean" = 2, "ICC" = 4, "Sw" = 4, "CRw" = 4, "CVw" = 4))
}
```

###Table 2a: Intra-Visit Repeatability
```{r}
# function that allows quick calculations of data
get_n_disease <- function(df, disease_status){df %>% filter(glc_dx_bin == disease_status) %>% group_by(ptid) %>% n_groups()}
```


All data was included for intra-visit repeatability statistics.

Intra-visit repeatability statistics for participants with repeated measurements on the same day:

* Normal (n = `r get_n_disease(data_octa_global_intra_1eye, "Normal")`).

* Glaucoma (n = `r get_n_disease(data_octa_global_intra_1eye, "Glaucoma")`).

```{r}
get_big_stats_table(df_normal = data_octa_global_intra_1eye, df_glaucoma = data_octa_global_intra_1eye)
```

###Table 2b: Inter-Visit Reproducibility

Data was restricted to 1 year for inter-visits that occurred on different days. This was to avoid changes in eyes over a long amount of time. 

Inter-visit reproducibility statistics for participants with repeated measurements within a 1 year window

* Normal (n = `r get_n_disease(data_octa_global_inter_1eye365, "Normal")`).

* Glaucoma (n = `r get_n_disease(data_octa_global_inter_1eye365, "Glaucoma")`).

```{r}
get_big_stats_table(df_normal = data_octa_global_inter_1eye365, df_glaucoma = data_octa_global_inter_1eye365)
```



#Mixed Models, Both Eyes

Mixed Effects Regression Models allow random effects for certain variables. This allows us to include multiple measurements from the same person and eye while still satisfying independence.

## Figure 1{.tabset}

Here are the Bland Altman Plots for OCTA outcomes in both eyes. The variables of interest are VAD and FLUX for the current algorithm and the Zeiss algorithm. This is an interesting plot to show before explaing the mixed effects model.

```{r, warning = FALSE}
# function that creates bland altman plot data for each OCTA variable of interest
get_ba_data <- function(df, outcome){
  
  # get variable for dplyr
  outcome_dplyr <- enquo(outcome)
  
  # make OCTA variable name
  octa_name_df <- df %>% mutate(label = label(!!outcome_dplyr))
  octa_name <- octa_name_df[1, "label"] %>% as.character()
  
  get_blandaltman_data(df, outcome_dplyr) %>% 
    # create an indicator variable of the octa variable
    mutate(outcome = octa_name) %>% 
    select(ptid, eye_imaged, order_obs, eyeid, outcome, diff, mean, glc_dx_bin)

}

# create intra data
ba_data_intra <- bind_rows(
  get_ba_data(data_octa_global_intra_2eye, v_area_density),
  get_ba_data(data_octa_global_intra_2eye, zeiss_v_area_density),
  get_ba_data(data_octa_global_intra_2eye, flux),
  get_ba_data(data_octa_global_intra_2eye, zeiss_flux)
) %>% 
  # add the name of the data set
  mutate(data_type = "Intra-Visit")

# create inter data
ba_data_inter <- bind_rows(
  get_ba_data(data_octa_global_inter_2eye, v_area_density),
  get_ba_data(data_octa_global_inter_2eye, zeiss_v_area_density),
  get_ba_data(data_octa_global_inter_2eye, flux),
  get_ba_data(data_octa_global_inter_2eye, zeiss_flux)
) %>% 
  # add the name of the data set
  mutate(data_type = "Inter-Visit")

# combine intra and inter datasets
ba_data <- bind_rows(
  ba_data_intra,
  ba_data_inter
) %>% 
  mutate(
    outcome = factor(outcome, levels = c("Vessel Area Density", "Vessel Area Density, Zeiss", "Flux", "Flux, Zeiss")),
    data_type = factor(data_type, levels = c("Intra-Visit", "Inter-Visit"))
  )

# get summary data for confidence intervals
ba_data_summary <- ba_data %>% 
  group_by(data_type, outcome) %>% 
  summarise(
    diff_mean = mean(diff),
    diff_l95cl = diff_mean - 1.96*sd(diff),
    diff_u95cl = diff_mean + 1.96*sd(diff)
  )
```

## Vertical{.tabset}

Vertical image for paper manuscript

```{r}
# common plot specifications for vertical BA plots
p_fig1_facet_vertical <- function(df){
  
  df %>% 
    ggplot(aes(x = mean, y = diff)) +
    geom_point(size = 0.1, alpha = 1) +
    geom_hline(data = ba_data_summary, aes(yintercept = diff_mean), colour = "blue", size = 0.5, linetype = 2) +
    geom_hline(data = ba_data_summary, aes(yintercept = diff_l95cl), colour = "red", size = 0.5, linetype = 2) +
    geom_hline(data = ba_data_summary, aes(yintercept = diff_u95cl), colour = "red", size = 0.5, linetype = 2) +
    facet_grid(outcome ~ data_type) +
    scale_y_continuous(limits = c(-0.14, 0.14), breaks = round(seq(from = -0.1, to = 0.1, by = 0.05), 2)) +
    scale_x_continuous(limits = c(0, 0.5)) +
    ylab("Difference in Measurements") +
    xlab("Average Measurements") +
    theme(
      axis.text = element_text(size = 6),
      plot.title = element_text(hjust = 0.5, size = 6),
      strip.text = element_text(size = 8)
      )
  
}
```

```{r}
# create bland altman plot from data: vertical for paper
figure1_facet_vertical <- ba_data %>% p_fig1_facet_vertical()

# save vertical figure 1 for use in paper
dev.copy(tiff, "figure1_facet_v_paper.tiff", width = 1200, height = 2000, res = 300) %>% invisible()
figure1_facet_vertical
dev.off() %>% invisible()
```
![](figure1_facet_v_paper.tiff)

### Normal

```{r}
figure1_facet_vertical_normal <- ba_data %>% dplyr::filter(glc_dx_bin == "Normal") %>% p_fig1_facet_vertical() + ggtitle("Normal Eyes") + theme(plot.title = element_text(size = 12))

# save vertical figure 1 for use in paper
dev.copy(tiff, "figure1_facet_v_paper_normal.tiff", width = 1200, height = 2000, res = 300) %>% invisible()
figure1_facet_vertical_normal
dev.off() %>% invisible()
```
![](figure1_facet_v_paper_normal.tiff)

### Glaucoma

```{r}
figure1_facet_vertical_glaucoma <- ba_data %>% dplyr::filter(glc_dx_bin == "Glaucoma") %>% p_fig1_facet_vertical() + ggtitle("Glaucoma Eyes")+ theme(plot.title = element_text(size = 12))

# save vertical figure 1 for use in paper
dev.copy(tiff, "figure1_facet_v_paper_glaucoma.tiff", width = 1200, height = 2000, res = 300) %>% invisible()
figure1_facet_vertical_glaucoma
dev.off() %>% invisible()
```
![](figure1_facet_v_paper_glaucoma.tiff)


## Horizontal{.tabset}

Horizontal image for poster presentations

```{r}
# common plot specifications for vertical BA plots
p_fig1_facet_horizontal <- function(df){
  
  df %>% 
    ggplot(aes(x = mean, y = diff)) +
      geom_point(size = 0.1, alpha = 1) +
      geom_hline(data = ba_data_summary, aes(yintercept = diff_mean), colour = "blue", size = 0.5, linetype = 2) +
      geom_hline(data = ba_data_summary, aes(yintercept = diff_l95cl), colour = "red", size = 0.5, linetype = 2) +
      geom_hline(data = ba_data_summary, aes(yintercept = diff_u95cl), colour = "red", size = 0.5, linetype = 2) +
      facet_grid(data_type ~ outcome) +
      scale_y_continuous(limits = c(-0.14, 0.14), breaks = round(seq(from = -0.1, to = 0.1, by = 0.05), 2)) +
      scale_x_continuous(limits = c(0, 0.5)) +
      ylab("Difference in Measurements") +
      xlab("Average Measurements") +
      theme(
        axis.text = element_text(size = 6),
        plot.title = element_text(hjust = 0.5, size = 6),
        strip.text = element_text(size = 8)
        )
  
}
```

```{r}
# create bland altman plot from data: horizontal for presentations
figure1_facet_horizontal <- ba_data %>% p_fig1_facet_horizontal()

# save horizontal figure 1 for use in slides
dev.copy(tiff, "figure1_facet_h_slides.tiff", width = 2000, height = 1200, res = 300) %>% invisible()
figure1_facet_horizontal
dev.off() %>% invisible()
```
![](figure1_facet_h_slides.tiff)

### Normal

```{r}
figure1_facet_horizontal_normal <- ba_data %>% dplyr::filter(glc_dx_bin == "Normal") %>% p_fig1_facet_horizontal() + ggtitle("Normal Eyes") + theme(plot.title = element_text(size = 12))

# save horizontal figure 1 for use in slides
dev.copy(tiff, "figure1_facet_h_slides_normal.tiff", width = 2000, height = 1200, res = 300) %>% invisible()
figure1_facet_horizontal_normal
dev.off() %>% invisible()
```
![](figure1_facet_h_slides_normal.tiff)

### Glaucoma

```{r}
figure1_facet_horizontal_glaucoma <- ba_data %>% dplyr::filter(glc_dx_bin == "Glaucoma") %>% p_fig1_facet_horizontal() + ggtitle("Glaucoma Eyes")+ theme(plot.title = element_text(size = 12))

# save horizontal figure 1 for use in slides
dev.copy(tiff, "figure1_facet_h_slides_glaucoma.tiff", width = 2000, height = 1200, res = 300) %>% invisible()
figure1_facet_horizontal_glaucoma
dev.off() %>% invisible()
```
![](figure1_facet_h_slides_glaucoma.tiff)


## Adjusting for Patients

This model has a random effect for the participant ID, which accounts for repeated measurements on the same person. This does not, however, account for measurements on more than one eye per person. Therefore the data was used that randomly selected one eye per participant. Later models will adjust for this.

This should produce the same ICC and other reliability statistics as the ICCest() function in the tables above. These were not calculated out to compare. Just one model is shown for explanation.

```{r}
model_1eye_fit <- lmer(v_area_density ~ (1|ptid), data=data_octa_global_intra_1eye)
summary(model_1eye_fit)
```


##Adjusting for Both Eyes and Patients

Linear, mixed-effects modeling was used to account for repeated measurements on both eyes of each participant. This allows random effects for both the patient and the eye (left or right), allowing us to model the ICC and other reliability statistics without violating independence.

```{r}
# example of the linear mixed effect model that accounts for random patient and eye terms
model_2eye_fit <- lmer(v_area_density ~ (1 | ptid / eyeid), data = data_octa_global_intra_2eye)
summary(model_2eye_fit)
```


### Table 3: Reliability Statistics, Both Eyes
```{r}
# this function calculates the reliability statistics, but for both eyes, not just one
get_big_stats_table_2eyes <- function(df){

  # OCTA outcome variables of interest
  # octa_vars_select_vars    # defined above about line 1700

  # dataframes of glaucoma disease status
  df_normal   <- df %>% filter(glc_dx_bin == "Normal")
  df_glaucoma <- df %>% filter(glc_dx_bin == "Glaucoma")
  
  # function that returns ICC w/95% confidence intervals 
  get_adjusted_icc <- function(measurement, df){
    
    # format formula of measurement outcome and random effects of patient and eye
    lmer_formula <- as.formula(paste(measurement, "~ (1 | ptid / eyeid)"))
    
    # linear mixed effects model
    model_2eye <- lmer(lmer_formula, data = df)
    
    # calculate mean of variable
    mean_measure <- mean(df[[measurement]])
  
    # function that calculates ICC
    calc_icc <- function(x){
      
      # print variances from lme model
      var_corr <- as.data.frame(VarCorr(x))
   
      # get variance between: patient variance + eye variance
      var_between <- var_corr$vcov[1] + var_corr$vcov[2]
      
      # get variance within: residual variance
      var_within  <- var_corr$vcov[3]
      
      # calculate icc
      (var_between) / (var_between + var_within)
      
    }
    
    # function that caclulates Sw, Within-Subject Standard Deviation
    calc_sw <- function(x){
      
      # print variances from lme model
      var_corr <- as.data.frame(VarCorr(x))
      
      # Sw is the standard error of the residual term in the model
      var_corr$sdcor[3]
  
    }
    
    # function that caclulates CRw, Within-Subject Coefficient of Repeatability
    calc_crw <- function(x){
      
      # print variances from lme model
      var_corr <- as.data.frame(VarCorr(x))
      
      # CRw is the standard error of the residual term in the model, times Sqrt(2), times 1.96
      var_corr$sdcor[3] * sqrt(2) * 1.96
  
    }
    
    # function that caclulates CVw, Within-Subject Coefficient of Variation
    calc_cvw <- function(x, mu_mean){
        
      # print variances from lme model
      var_corr <- as.data.frame(VarCorr(x))
        
      # CVw is the standard error of the residual term in the model, divided by the mean
      var_corr$sdcor[3] / mean_measure * 100
    
    }
    
    # calculate confidence intervals with bootstrap methods
    #     assumes normal distribution of residuals
    #     https://stats.stackexchange.com/questions/184767/how-do-i-calculate-the-confidence-interval-of-an-icc
    get_cl95 <- function(x){
      
      # calculate the bootstrap distribution
      boot_x <- bootMer(model_2eye, x, nsim = 1000)   # nsim = 1000 is standard, but 1hr. 100 probably sufficient. 10 fast enough to edit code
      
      # draw from the bootstrap distribution the usual 95% upper and lower confidence limits
      quantile(boot_x$t, c(0.025, 0.975))
      
    }
      
      # return ICC w/95% confidence intervals
      return(
        tibble(
          
          # variable name
          var_name = measurement,
          
          n_participant = df %>% group_by(ptid) %>% n_groups(),
          
          # average measurement
          mu = mean_measure,
        
          # calculate icc
          icc = calc_icc(model_2eye),
          
            # 95% lower CL
            icc_lower_cl = get_cl95(calc_icc)[[1]],
            
            # 95% upper CL
            icc_upper_cl = get_cl95(calc_icc)[[2]],
          
          # calculate sw
          sw = calc_sw(model_2eye),
          
            # 95% lower CL
            sw_lower_cl = get_cl95(calc_sw)[[1]],
            
            # 95% upper CL
            sw_upper_cl = get_cl95(calc_sw)[[2]],      
          
          # calculate CRw
          crw = calc_crw(model_2eye),
          
            # 95% lower CL
            crw_lower_cl = get_cl95(calc_crw)[[1]],
            
            # 95% upper CL
            crw_upper_cl = get_cl95(calc_crw)[[2]],   
          
          # calculate CVw
          cvw = calc_cvw(model_2eye),
          
            # 95% lower CL
            cvw_lower_cl = get_cl95(calc_cvw)[[1]],
            
            # 95% upper CL
            cvw_upper_cl = get_cl95(calc_cvw)[[2]]
          
        ))
      
  }
  
  # function that applies the ICC function to multiple OCTA outcome variables
  get_icc_disease_group <- function(var_names, df_disease){
    
    # get name of disease group
    disease_group_name <- deparse(substitute(df_disease))
    
    # bind all the icc outcomes
    bind_rows(
      map(
        .x = var_names,
        .f = get_adjusted_icc,
        df = df_disease
        )) %>% 
      
      # add column of glaucoma disease status
      mutate(disease = str_remove(disease_group_name, "df_"))
    
  }
  
  # names of variables to include in tables
  vars_reliable_table <- c("n_participant", "mu", outer(c("icc", "sw", "crw", "cvw"), c("", "_lower_cl", "_upper_cl"), FUN = "paste0")) 
  vars_reliable_table_pretty <- paste0("pretty_", unique(str_remove(vars_reliable_table, pattern = regex("_lower|_upper"))))
  
  # get raw data for table
  table_data <- bind_rows(
    get_icc_disease_group(var_names = octa_vars_select_vars, df_normal),
    get_icc_disease_group(var_names = octa_vars_select_vars, df_glaucoma)
  ) %>% 
    # create pretty, formatted variables for data
    mutate(      
      pretty_n_participant = as.integer(n_participant),
      pretty_mu = trim3(mu),
      pretty_icc = trim3(icc),
      pretty_icc_cl = trim_ci_pretty(icc_lower_cl, icc_upper_cl),
      pretty_sw = trim3(sw),
      pretty_sw_cl = trim_ci_pretty(sw_lower_cl, sw_upper_cl),
      pretty_crw = trim3(crw),
      pretty_crw_cl = trim_ci_pretty(crw_lower_cl, crw_upper_cl),    
      pretty_cvw = trim3(cvw),
      pretty_cvw_cl = trim_ci_pretty(cvw_lower_cl, cvw_upper_cl)
      ) %>% 
    # spread data
    pivot_wider(id_cols = var_name, names_from = disease, values_from = c(vars_reliable_table, vars_reliable_table_pretty)) %>% 
    # order variables into proper format
    select(var_name, ends_with("normal"), ends_with("glaucoma")) %>%     # first order by disease status: normal, glaucoma
    select(var_name, contains("n_participant_"), contains("mu_"), contains("icc_"), contains("sw_"), contains("crw_"), contains("cvw_")) # then order by reliability: mu, icc, sw, etc.
  
  # select pretty data only for printing
  table_data_pretty <- table_data %>% 
    select(var_name, starts_with("pretty")) %>% 
    mutate(var_name = var_labels[octa_vars_select_vars])
  
  # make kable of table output
  table_data_pretty %>% 
    kable(digits = 3, format = "html") %>% 
        kable_styling(
          #bootstrap table classes
          bootstrap_options = c( "hover")
        ) %>% 
        # group column headers
        add_header_above(c(" " = 1, rep(c("Normal" = 1, "Glaucoma" = 1), times = 2), rep(c("Normal" = 2, "Glaucoma" = 2), times = 4))) %>%
        add_header_above(c("OCTA Variable" = 1, "N Participants" = 2, "Mean" = 2, "ICC" = 4, "Sw" = 4, "CRw" = 4, "CVw" = 4))
  
}
# get_big_stats_table_2eyes(df = data_octa_global_intra_2eye)
```

### Table 3a: Both Eyes, Intra-Visit Repeatability
```{r}
get_big_stats_table_2eyes(df = data_octa_global_intra_2eye)
```

### Table 3b: Both Eyes, Inter-Visit Reproducibility{.tabset}
Look at data by different time restrictions, to see if the ICC increases as the window of time shortens.

**I recommend we use the one that restricts to a single year (365 Days), in spite of the singularity warning. I included all possibilities for reference, however.

####All
```{r}
get_big_stats_table_2eyes(df = data_octa_global_inter_2eye)
```

####365 Days
```{r}
get_big_stats_table_2eyes(df = data_octa_global_inter_2eye365)
```

####180 Days
```{r}
get_big_stats_table_2eyes(df = data_octa_global_inter_2eye180)
```



# Signal Strength, Both Eyes

We take for granted that signal strength affects the OCTA outcome variables. But we should still show this formally, as Venugopal 2018 has at the end of their paper.

"Signal strength index values of the scans had a significant effect on the repeatability of OCTA with the vessel density values increasing in scans with higher SSI values." [@venugopalRepeatabilityVesselDensity2018]

Their result is a simple table of regression estimates for signal strength, shown in the output below. We're really showing here that SS is important to include as a covariate in measurements that use OCTA.

## Linear Mixed Effects Model
This is an example of the LME Model used to calculate coefficients in the table below
```{r}
model_ss_fit <- lmer(v_area_density ~ signal_strength + (1|ptid / eyeid), data = data_octa_global_intra_2eye)
summary(model_ss_fit)
```

## Signal Strength Affects Reliability of OCTA Measurements{.tabset}

```{r}
# OCTA outcome variables of interest
# octa_vars_select_vars    # defined above about line 1700

get_ss_table <- function(df_disease){

  get_ss_row <- function(measurement, df){
    
    # formula for signal strength
    formula_ss <- as.formula(paste0(measurement, " ~ signal_strength + (1|ptid / eyeid)"))
    
    # get model
    model_ss_fit <- lmer(formula_ss, data = df)
    
    # get beta statistics table
    beta_out <- summary(model_ss_fit)$coefficients 
    
    # get names of variables
    vars <- beta_out %>% row.names()
    
    # get index that corresponds to signal_strength
    index_ss <- 2
    
    # create output as a single horizontal row
    beta_out_ss <- beta_out[index_ss,] %>% t() %>% as.data.frame()
    
    # add parameter outcome and estimate (ss) before stats
    bind_cols(octa_outcome = measurement, parameter = vars[index_ss], beta_out_ss)
    
  }
  
  # get data table for signal strength beta estimates
  ss_table <- map_dfr(
    .x = octa_vars_select_vars,
    .f = get_ss_row,
    df = df_disease
    ) %>% 
    # create pretty variables
    mutate(
      l_95_cl = Estimate - 1.96 * `Std. Error`,
      u_95_cl = Estimate + 1.96 * `Std. Error`,
      pretty_beta = trim3(Estimate),
      pretty_se = trim3(`Std. Error`),
      pretty_cl = trim_ci_pretty(l_95_cl, u_95_cl),
      pretty_pval = trim3(`Pr(>|t|)`)
    )
  
  ss_table %>% 
    select(octa_outcome, parameter, pretty_beta, pretty_se, pretty_cl, pretty_pval) %>% 
    kable() %>% 
    kable_styling(bootstrap_options = c( "hover"))
  
}
```

###Overall
```{r}
get_ss_table(df_disease = data_octa_global_intra_2eye)
```

###Normal
```{r}
get_ss_table(df_disease = data_octa_global_intra_2eye %>% dplyr::filter(glc_dx_bin == "Normal"))
```

###Glaucoma
```{r}
get_ss_table(df_disease = data_octa_global_intra_2eye %>% dplyr::filter(glc_dx_bin == "Glaucoma"))
```



# Visual Field, Both Eyes

Are anatomical differences in retinal blood flow predict what patients are experiencing? We use OCTA variables as the independent variable to see if they are associated with total mean deviation, a measure of visual field loss.

Their result is a simple table of regression estimates for mean deviation of visual field, shown in the output below. 

```{r}
data_md_vfl_raw <- read_xlsx(
  paste0(dir_data, "/R&R_PoHX_IOP_MD_all_20200310.xlsx"), sheet = "VF_MD",
  col_types = c(rep("text", 3), "numeric", "text", rep("date", 2), rep("numeric", 6))
  ) 

data_md_vfl <- data_md_vfl_raw %>% 
  janitor::clean_names(case = "snake") %>% 
  dplyr::rename(
    ptid = sid, date_vf = vf_date,
    falsepos_od = pos_od_percent, falseneg_od = neg_od_percent,
    falsepos_os = pos_os_percent, falseneg_os = neg_os_percent
    ) %>% 
  dplyr::select(ptid, date_vf, ends_with("_od"), ends_with("_os"))

data_md_vfl_long <- data_md_vfl %>% 
  pivot_longer(cols = c(ends_with("_od"), ends_with("_os")), values_to = "value", names_to = "measure_eye") %>% 
  separate(col = "measure_eye", into = c("measure", "eye"), sep = "_") %>% 
  dplyr::mutate(eye_imaged = case_when(eye == "os" ~ 1, eye == "od" ~ 2) %>% form_eye()) %>% 
  dplyr::arrange(ptid, eye, date_vf) %>% 
  dplyr::filter(!is.na(value)) %>% 
  dplyr::select(-eye) 

data_md_vfl_wide <- data_md_vfl_long %>% 
  pivot_wider(id_cols = c("ptid", "eye_imaged", "date_vf"), names_from = "measure", values_from = "value")
```

`r data_octa_global_intra_2eye %>% group_by(ptid) %>% n_groups()` participants had intra-visit measurements.

`r data_md_vfl_raw %>% group_by(SID) %>% n_groups()` participants had visual field loss measurements 

## Exclusion Criteria

The visual field (VF) measurement at the first day was used, and all repeated measurements were excluded.

VF measurements were excluded if they had:

- Greater than 15% false positive error rates

- Greater than 15% false negative error rates

```{r}
data_md_vfl_exclude <- data_md_vfl_wide %>% dplyr::filter(falsepos <= 15 | falseneg <= 15)

# test <-  data_octa_global_intra_2eye_vfl %>% dplyr::filter(is.na(md))
```

`r data_md_vfl_exclude %>% group_by(ptid) %>% n_groups()` participants had reliable visual field loss measurements 

## First Measurement

Participants may have had multiple VF measurements on their eyes. Only take the first measurement at their first visit.

```{r}
data_md_vfl_exclude_first <- data_md_vfl_exclude %>%
  group_by(ptid, eye_imaged) %>%
  top_n(1, wt = date_vf) %>%
  ungroup() 
```


Join VF data to intra-visit data

```{r, warning = FALSE}
data_octa_global_intra_2eye_vfl <- data_octa_global_intra_2eye %>% 
  left_join(data_md_vfl_exclude_first, by = c("ptid", "eye_imaged"))

# data_octa_global_intra_2eye_vfl %>% glimpse
```

`r data_octa_global_intra_2eye_vfl %>% dplyr::filter(!is.na(md)) %>% group_by(ptid) %>% n_groups()` participants had reliable visual field loss measurements in the intra-visit data.

## Linear Mixed Effects Model

This is an example of the LME Model used to calculate coefficients in the table below

```{r}
model_md_fit <- lmer(v_area_density ~ md + signal_strength + (1|ptid / eyeid), data = data_octa_global_intra_2eye_vfl)
summary(model_md_fit)

# test <- data_octa_global_intra_2eye_vfl %>% select(ptid, eyeid, v_area_density, md, signal_strength) 
```

## Total Mean Deviation Associated with OCTA Measurements{.tabset}

OCTA outcomes were associated with total mean deviation, adjusting for signal strength in the mixed effects models.

This occurs in all patients, and also separately when stratifying by glaucoma diagnosis.

```{r}
# OCTA outcome variables of interest
# octa_vars_select_vars    # defined above about line 1700

get_md_table <- function(df_disease){

  get_md_row <- function(measurement, df){
    
    # formula for signal strength
    formula_md <- as.formula(paste0(measurement, "~ md + signal_strength + (1|ptid / eyeid)"))
    
    # get model
    model_md_fit <- lmer(formula_md, data = df)
    
    # get beta statistics table
    beta_out <- summary(model_md_fit)$coefficients 
    
    # get names of variables
    vars <- beta_out %>% row.names()
    
    # get index that corresponds to signal_strength
    index_md <- 2
    
    # create output as a single horizontal row
    beta_out_md <- beta_out[index_md,] %>% t() %>% as.data.frame()
    
    # add parameter outcome and estimate (ss) before stats
    bind_cols(octa_outcome = measurement, parameter = vars[index_md], beta_out_md)
    
  }
  
  # get data table for signal strength beta estimates
  md_table <- map_dfr(
    .x = octa_vars_select_vars,
    .f = get_md_row,
    df = df_disease
    ) %>% 
    # create pretty variables
    mutate(
      l_95_cl = Estimate - 1.96 * `Std. Error`,
      u_95_cl = Estimate + 1.96 * `Std. Error`,
      pretty_beta = trim3(Estimate),
      pretty_se = trim3(`Std. Error`),
      pretty_cl = trim_ci_pretty(l_95_cl, u_95_cl),
      pretty_pval = trim3(`Pr(>|t|)`)
    )
  
  md_table %>% 
    select(octa_outcome, parameter, pretty_beta, pretty_se, pretty_cl, pretty_pval) %>% 
    kable() %>% 
    kable_styling(bootstrap_options = c( "hover"))
  
}
```

###Overall
```{r}
get_md_table(df_disease = data_octa_global_intra_2eye_vfl)
```

###Normal
```{r}
get_md_table(df_disease = data_octa_global_intra_2eye_vfl %>% dplyr::filter(glc_dx_bin == "Normal"))
```

###Glaucoma
```{r}
get_md_table(df_disease = data_octa_global_intra_2eye_vfl %>% dplyr::filter(glc_dx_bin == "Glaucoma"))
```


# Sensitivity Analysis

After review, some comments suggested various sensitivity analyses. 

## Glaucoma Severity

"Of 118 glaucoma eyes, we have 35 mild, 33 moderate, 50 severe. This seems fairly sufficient to address this no? If it's better for the analysis, we could also clump mild and moderate. Let me know what you think and if we could do a little analysis on this. I really think it will demonstrate to the readers that we are trying to make the most of the data we have to address the question of whether disease severity affects repeatability, which is an important one.. Even if our conclusion is that we are underpowered, to show some sort of preliminary analysis on this may be helpful."

- G. Richter

### Summary Stats

Note, the total number of people measured is less than the sum of people in each glaucoma severity group. This is because some people have eyes with different glaucoma severity. For example, a person may have one eye with mild glaucoma and the other with no glaucoma; this person is counted twice.

#### Total Measurements

```{r}
data_octa_global_intra_2eye %>% 
  summarise(
    n_people = n_distinct(ptid),
    n_eyes = n_distinct(eyeid),
    n_measurements = n()
    ) %>% 
  quick_kable()
```

#### Measurements by Glaucoma Severity

##### Intra-session

```{r}
data_octa_global_intra_2eye %>% 
  group_by(forcats::fct_explicit_na(glc_dx)) %>% 
  summarise(
    n_people = n_distinct(ptid),
    n_eyes = n_distinct(eyeid),
    n_measurements = n()
    ) %>% 
  ungroup() %>% 
  janitor::adorn_totals("row") %>% 
  quick_kable()
```

##### Inter-session{.tabset}

###### All

```{r}
data_octa_global_inter_2eye365 %>% 
  group_by(forcats::fct_explicit_na(glc_dx)) %>% 
  summarise(
    n_people = n_distinct(ptid),
    n_eyes = n_distinct(eyeid),
    n_measurements = n()
    ) %>% 
  ungroup() %>% 
  janitor::adorn_totals("row") %>% 
  quick_kable()
```

###### 180 Days

```{r}
data_octa_global_inter_2eye180 %>% 
  group_by(forcats::fct_explicit_na(glc_dx)) %>% 
  summarise(
    n_people = n_distinct(ptid),
    n_eyes = n_distinct(eyeid),
    n_measurements = n()
    ) %>% 
  ungroup() %>% 
  janitor::adorn_totals("row") %>% 
  quick_kable()
```

### Function

This function creates a similar table of measurement stats, but stratified by glaucoma severity level.

```{r}
# this function calculates the reliability statistics, but for both eyes, not just one
get_2eyes_glc_sev <- function(glc_dx_lvl, df = data_octa_global_intra_2eye){

  # OCTA outcome variables of interest
  # octa_vars_select_vars    # defined above about line 1700

  # dataframe filtered to one glaucoma level (normal, mild, moderate, severe)
  df <- df %>% filter(glc_dx == glc_dx_lvl)
  
  # function that returns ICC w/95% confidence intervals 
  get_adjusted_icc <- function(measurement, df){
    
    # format formula of measurement outcome and random effects of patient and eye
    lmer_formula <- as.formula(paste(measurement, "~ (1 | ptid / eyeid)"))
    
    # linear mixed effects model
    model_2eye <- lmer(lmer_formula, data = df)
    
    # calculate mean of variable
    mean_measure <- mean(df[[measurement]])
  
    # function that calculates ICC
    calc_icc <- function(x){
      
      # print variances from lme model
      var_corr <- as.data.frame(VarCorr(x))
   
      # get variance between: patient variance + eye variance
      var_between <- var_corr$vcov[1] + var_corr$vcov[2]
      
      # get variance within: residual variance
      var_within  <- var_corr$vcov[3]
      
      # calculate icc
      (var_between) / (var_between + var_within)
      
    }
    
    # function that caclulates Sw, Within-Subject Standard Deviation
    calc_sw <- function(x){
      
      # print variances from lme model
      var_corr <- as.data.frame(VarCorr(x))
      
      # Sw is the standard error of the residual term in the model
      var_corr$sdcor[3]
  
    }
    
    # function that caclulates CRw, Within-Subject Coefficient of Repeatability
    calc_crw <- function(x){
      
      # print variances from lme model
      var_corr <- as.data.frame(VarCorr(x))
      
      # CRw is the standard error of the residual term in the model, times Sqrt(2), times 1.96
      var_corr$sdcor[3] * sqrt(2) * 1.96
  
    }
    
    # function that caclulates CVw, Within-Subject Coefficient of Variation
    calc_cvw <- function(x, mu_mean){
        
      # print variances from lme model
      var_corr <- as.data.frame(VarCorr(x))
        
      # CVw is the standard error of the residual term in the model, divided by the mean
      var_corr$sdcor[3] / mean_measure * 100
    
    }
    
    # calculate confidence intervals with bootstrap methods
    #     assumes normal distribution of residuals
    #     https://stats.stackexchange.com/questions/184767/how-do-i-calculate-the-confidence-interval-of-an-icc
    get_cl95 <- function(x){
      
      # calculate the bootstrap distribution
      boot_x <- bootMer(model_2eye, x, nsim = 1000)   # nsim = 1000 is standard, but 1hr. 100 probably sufficient. 10 fast enough to edit code
      
      # draw from the bootstrap distribution the usual 95% upper and lower confidence limits
      quantile(boot_x$t, c(0.025, 0.975))
      
    }
      
      # return ICC w/95% confidence intervals
      return(
        tibble(
          
          # variable name
          var_name = measurement,
          
          n_participant = df %>% group_by(ptid) %>% n_groups(),
          
          # average measurement
          mu = mean_measure,
        
          # calculate icc
          icc = calc_icc(model_2eye),
          
            # 95% lower CL
            icc_lower_cl = get_cl95(calc_icc)[[1]],
            
            # 95% upper CL
            icc_upper_cl = get_cl95(calc_icc)[[2]],
          
          # calculate sw
          sw = calc_sw(model_2eye),
          
            # 95% lower CL
            sw_lower_cl = get_cl95(calc_sw)[[1]],
            
            # 95% upper CL
            sw_upper_cl = get_cl95(calc_sw)[[2]],      
          
          # calculate CRw
          crw = calc_crw(model_2eye),
          
            # 95% lower CL
            crw_lower_cl = get_cl95(calc_crw)[[1]],
            
            # 95% upper CL
            crw_upper_cl = get_cl95(calc_crw)[[2]],   
          
          # calculate CVw
          cvw = calc_cvw(model_2eye),
          
            # 95% lower CL
            cvw_lower_cl = get_cl95(calc_cvw)[[1]],
            
            # 95% upper CL
            cvw_upper_cl = get_cl95(calc_cvw)[[2]]
          
        ))
      
  }
  
  # function that applies the ICC function to multiple OCTA outcome variables
  get_icc_disease_group <- function(var_names, df_disease){

    # bind all the icc outcomes
    bind_rows(
      map(
        .x = var_names,
        .f = get_adjusted_icc,
        df = df_disease
        )) %>% 
      
      # add column of glaucoma disease status
      mutate(disease = glc_dx_lvl)
    
  }
  
  # names of variables to include in tables
  vars_reliable_table <- c("n_participant", "mu", outer(c("icc", "sw", "crw", "cvw"), c("", "_lower_cl", "_upper_cl"), FUN = "paste0"))
  vars_reliable_table_pretty <- paste0("pretty_", unique(str_remove(vars_reliable_table, pattern = regex("_lower|_upper"))))
  
  # get raw data for table
  table_data <- get_icc_disease_group(var_names = octa_vars_select_vars, df) %>%
    # create pretty, formatted variables for data
    mutate(
      n_participant = as.integer(n_participant),
      pretty_mu = trim3(mu),
      pretty_icc = trim3(icc),
      pretty_icc_cl = trim_ci_pretty(icc_lower_cl, icc_upper_cl),
      pretty_sw = trim3(sw),
      pretty_sw_cl = trim_ci_pretty(sw_lower_cl, sw_upper_cl),
      pretty_crw = trim3(crw),
      pretty_crw_cl = trim_ci_pretty(crw_lower_cl, crw_upper_cl),
      pretty_cvw = trim3(cvw),
      pretty_cvw_cl = trim_ci_pretty(cvw_lower_cl, cvw_upper_cl)
      ) 
  
  table_data_pretty <- table_data %>% 
    select(disease, contains("n_participant"), var_name, contains("pretty")) %>% 
    mutate(var_name = var_labels[octa_vars_select_vars])

  # make kable of table output
  table_data_pretty %>%
    kable(digits = 3, format = "html") %>%
        kable_styling(
          #bootstrap table classes
          bootstrap_options = c( "hover")
        ) %>% 
    add_header_above(c("Glaucoma Severity" = 1, "OCTA Variable" = 1, "N Participants" = 1, "Mean" = 1, "ICC" = 2, "Sw" = 2, "CRw" = 2, "CVw" = 2))
  
}
# get_2eyes_glc_sev("Moderate")
```

### Glaucoma: None

```{r}
get_2eyes_glc_sev("None")
```

### Glaucoma: Mild

```{r}
get_2eyes_glc_sev("Mild")
```

### Glaucoma: Moderate

```{r}
get_2eyes_glc_sev("Moderate")
```

### Glaucoma: Severe

```{r}
get_2eyes_glc_sev("Severe")
```

#References